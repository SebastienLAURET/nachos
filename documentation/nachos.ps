%!PS-Adobe-2.0
%%Creator: dvips(k) 5.95a Copyright 2005 Radical Eye Software
%%Title: nachos.dvi
%%Pages: 16
%%PageOrder: Ascend
%%BoundingBox: 0 0 612 792
%%DocumentFonts: Times-Bold Times-Roman Times-Italic Courier
%%DocumentPaperSizes: Letter
%%EndComments
%DVIPSWebPage: (www.radicaleye.com)
%DVIPSCommandLine: dvips -t letter nachos.dvi -o nachos.ps
%DVIPSParameters: dpi=600
%DVIPSSource:  TeX output 2005.08.17:1712
%%BeginProcSet: tex.pro 0 0
%!
/TeXDict 300 dict def TeXDict begin/N{def}def/B{bind def}N/S{exch}N/X{S
N}B/A{dup}B/TR{translate}N/isls false N/vsize 11 72 mul N/hsize 8.5 72
mul N/landplus90{false}def/@rigin{isls{[0 landplus90{1 -1}{-1 1}ifelse 0
0 0]concat}if 72 Resolution div 72 VResolution div neg scale isls{
landplus90{VResolution 72 div vsize mul 0 exch}{Resolution -72 div hsize
mul 0}ifelse TR}if Resolution VResolution vsize -72 div 1 add mul TR[
matrix currentmatrix{A A round sub abs 0.00001 lt{round}if}forall round
exch round exch]setmatrix}N/@landscape{/isls true N}B/@manualfeed{
statusdict/manualfeed true put}B/@copies{/#copies X}B/FMat[1 0 0 -1 0 0]
N/FBB[0 0 0 0]N/nn 0 N/IEn 0 N/ctr 0 N/df-tail{/nn 8 dict N nn begin
/FontType 3 N/FontMatrix fntrx N/FontBBox FBB N string/base X array
/BitMaps X/BuildChar{CharBuilder}N/Encoding IEn N end A{/foo setfont}2
array copy cvx N load 0 nn put/ctr 0 N[}B/sf 0 N/df{/sf 1 N/fntrx FMat N
df-tail}B/dfs{div/sf X/fntrx[sf 0 0 sf neg 0 0]N df-tail}B/E{pop nn A
definefont setfont}B/Cw{Cd A length 5 sub get}B/Ch{Cd A length 4 sub get
}B/Cx{128 Cd A length 3 sub get sub}B/Cy{Cd A length 2 sub get 127 sub}
B/Cdx{Cd A length 1 sub get}B/Ci{Cd A type/stringtype ne{ctr get/ctr ctr
1 add N}if}B/CharBuilder{save 3 1 roll S A/base get 2 index get S
/BitMaps get S get/Cd X pop/ctr 0 N Cdx 0 Cx Cy Ch sub Cx Cw add Cy
setcachedevice Cw Ch true[1 0 0 -1 -.1 Cx sub Cy .1 sub]{Ci}imagemask
restore}B/D{/cc X A type/stringtype ne{]}if nn/base get cc ctr put nn
/BitMaps get S ctr S sf 1 ne{A A length 1 sub A 2 index S get sf div put
}if put/ctr ctr 1 add N}B/I{cc 1 add D}B/bop{userdict/bop-hook known{
bop-hook}if/SI save N @rigin 0 0 moveto/V matrix currentmatrix A 1 get A
mul exch 0 get A mul add .99 lt{/QV}{/RV}ifelse load def pop pop}N/eop{
SI restore userdict/eop-hook known{eop-hook}if showpage}N/@start{
userdict/start-hook known{start-hook}if pop/VResolution X/Resolution X
1000 div/DVImag X/IEn 256 array N 2 string 0 1 255{IEn S A 360 add 36 4
index cvrs cvn put}for pop 65781.76 div/vsize X 65781.76 div/hsize X}N
/p{show}N/RMat[1 0 0 -1 0 0]N/BDot 260 string N/Rx 0 N/Ry 0 N/V{}B/RV/v{
/Ry X/Rx X V}B statusdict begin/product where{pop false[(Display)(NeXT)
(LaserWriter 16/600)]{A length product length le{A length product exch 0
exch getinterval eq{pop true exit}if}{pop}ifelse}forall}{false}ifelse
end{{gsave TR -.1 .1 TR 1 1 scale Rx Ry false RMat{BDot}imagemask
grestore}}{{gsave TR -.1 .1 TR Rx Ry scale 1 1 false RMat{BDot}
imagemask grestore}}ifelse B/QV{gsave newpath transform round exch round
exch itransform moveto Rx 0 rlineto 0 Ry neg rlineto Rx neg 0 rlineto
fill grestore}B/a{moveto}B/delta 0 N/tail{A/delta X 0 rmoveto}B/M{S p
delta add tail}B/b{S p tail}B/c{-4 M}B/d{-3 M}B/e{-2 M}B/f{-1 M}B/g{0 M}
B/h{1 M}B/i{2 M}B/j{3 M}B/k{4 M}B/w{0 rmoveto}B/l{p -4 w}B/m{p -3 w}B/n{
p -2 w}B/o{p -1 w}B/q{p 1 w}B/r{p 2 w}B/s{p 3 w}B/t{p 4 w}B/x{0 S
rmoveto}B/y{3 2 roll p a}B/bos{/SS save N}B/eos{SS restore}B end

%%EndProcSet
%%BeginProcSet: 8r.enc 0 0
% File 8r.enc  TeX Base 1 Encoding  Revision 2.0  2002-10-30
%
% @@psencodingfile@{
%   author    = "S. Rahtz, P. MacKay, Alan Jeffrey, B. Horn, K. Berry,
%                W. Schmidt, P. Lehman",
%   version   = "2.0",
%   date      = "30 October 2002",
%   filename  = "8r.enc",
%   email     = "tex-fonts@@tug.org",
%   docstring = "This is the encoding vector for Type1 and TrueType
%                fonts to be used with TeX.  This file is part of the
%                PSNFSS bundle, version 9"
% @}
% 
% The idea is to have all the characters normally included in Type 1 fonts
% available for typesetting. This is effectively the characters in Adobe
% Standard encoding, ISO Latin 1, Windows ANSI including the euro symbol,
% MacRoman, and some extra characters from Lucida.
% 
% Character code assignments were made as follows:
% 
% (1) the Windows ANSI characters are almost all in their Windows ANSI
% positions, because some Windows users cannot easily reencode the
% fonts, and it makes no difference on other systems. The only Windows
% ANSI characters not available are those that make no sense for
% typesetting -- rubout (127 decimal), nobreakspace (160), softhyphen
% (173). quotesingle and grave are moved just because it's such an
% irritation not having them in TeX positions.
% 
% (2) Remaining characters are assigned arbitrarily to the lower part
% of the range, avoiding 0, 10 and 13 in case we meet dumb software.
% 
% (3) Y&Y Lucida Bright includes some extra text characters; in the
% hopes that other PostScript fonts, perhaps created for public
% consumption, will include them, they are included starting at 0x12.
% These are /dotlessj /ff /ffi /ffl.
% 
% (4) hyphen appears twice for compatibility with both ASCII and Windows.
%
% (5) /Euro was assigned to 128, as in Windows ANSI
%
% (6) Missing characters from MacRoman encoding incorporated as follows:
%
%     PostScript      MacRoman        TeXBase1
%     --------------  --------------  --------------
%     /notequal       173             0x16
%     /infinity       176             0x17
%     /lessequal      178             0x18
%     /greaterequal   179             0x19
%     /partialdiff    182             0x1A
%     /summation      183             0x1B
%     /product        184             0x1C
%     /pi             185             0x1D
%     /integral       186             0x81
%     /Omega          189             0x8D
%     /radical        195             0x8E
%     /approxequal    197             0x8F
%     /Delta          198             0x9D
%     /lozenge        215             0x9E
%
/TeXBase1Encoding [
% 0x00
 /.notdef /dotaccent /fi /fl
 /fraction /hungarumlaut /Lslash /lslash
 /ogonek /ring /.notdef /breve
 /minus /.notdef /Zcaron /zcaron
% 0x10
 /caron /dotlessi /dotlessj /ff
 /ffi /ffl /notequal /infinity
 /lessequal /greaterequal /partialdiff /summation
 /product /pi /grave /quotesingle
% 0x20
 /space /exclam /quotedbl /numbersign
 /dollar /percent /ampersand /quoteright
 /parenleft /parenright /asterisk /plus
 /comma /hyphen /period /slash
% 0x30
 /zero /one /two /three
 /four /five /six /seven
 /eight /nine /colon /semicolon
 /less /equal /greater /question
% 0x40
 /at /A /B /C
 /D /E /F /G
 /H /I /J /K
 /L /M /N /O
% 0x50
 /P /Q /R /S
 /T /U /V /W
 /X /Y /Z /bracketleft
 /backslash /bracketright /asciicircum /underscore
% 0x60
 /quoteleft /a /b /c
 /d /e /f /g
 /h /i /j /k
 /l /m /n /o
% 0x70
 /p /q /r /s
 /t /u /v /w
 /x /y /z /braceleft
 /bar /braceright /asciitilde /.notdef
% 0x80
 /Euro /integral /quotesinglbase /florin
 /quotedblbase /ellipsis /dagger /daggerdbl
 /circumflex /perthousand /Scaron /guilsinglleft
 /OE /Omega /radical /approxequal
% 0x90
 /.notdef /.notdef /.notdef /quotedblleft
 /quotedblright /bullet /endash /emdash
 /tilde /trademark /scaron /guilsinglright
 /oe /Delta /lozenge /Ydieresis
% 0xA0
 /.notdef /exclamdown /cent /sterling
 /currency /yen /brokenbar /section
 /dieresis /copyright /ordfeminine /guillemotleft
 /logicalnot /hyphen /registered /macron
% 0xD0
 /degree /plusminus /twosuperior /threesuperior
 /acute /mu /paragraph /periodcentered
 /cedilla /onesuperior /ordmasculine /guillemotright
 /onequarter /onehalf /threequarters /questiondown
% 0xC0
 /Agrave /Aacute /Acircumflex /Atilde
 /Adieresis /Aring /AE /Ccedilla
 /Egrave /Eacute /Ecircumflex /Edieresis
 /Igrave /Iacute /Icircumflex /Idieresis
% 0xD0
 /Eth /Ntilde /Ograve /Oacute
 /Ocircumflex /Otilde /Odieresis /multiply
 /Oslash /Ugrave /Uacute /Ucircumflex
 /Udieresis /Yacute /Thorn /germandbls
% 0xE0
 /agrave /aacute /acircumflex /atilde
 /adieresis /aring /ae /ccedilla
 /egrave /eacute /ecircumflex /edieresis
 /igrave /iacute /icircumflex /idieresis
% 0xF0
 /eth /ntilde /ograve /oacute
 /ocircumflex /otilde /odieresis /divide
 /oslash /ugrave /uacute /ucircumflex
 /udieresis /yacute /thorn /ydieresis
] def


%%EndProcSet
%%BeginProcSet: texps.pro 0 0
%!
TeXDict begin/rf{findfont dup length 1 add dict begin{1 index/FID ne 2
index/UniqueID ne and{def}{pop pop}ifelse}forall[1 index 0 6 -1 roll
exec 0 exch 5 -1 roll VResolution Resolution div mul neg 0 0]FontType 0
ne{/Metrics exch def dict begin Encoding{exch dup type/integertype ne{
pop pop 1 sub dup 0 le{pop}{[}ifelse}{FontMatrix 0 get div Metrics 0 get
div def}ifelse}forall Metrics/Metrics currentdict end def}{{1 index type
/nametype eq{exit}if exch pop}loop}ifelse[2 index currentdict end
definefont 3 -1 roll makefont/setfont cvx]cvx def}def/ObliqueSlant{dup
sin S cos div neg}B/SlantFont{4 index mul add}def/ExtendFont{3 -1 roll
mul exch}def/ReEncodeFont{CharStrings rcheck{/Encoding false def dup[
exch{dup CharStrings exch known not{pop/.notdef/Encoding true def}if}
forall Encoding{]exch pop}{cleartomark}ifelse}if/Encoding exch def}def
end

%%EndProcSet
%%BeginProcSet: special.pro 0 0
%!
TeXDict begin/SDict 200 dict N SDict begin/@SpecialDefaults{/hs 612 N
/vs 792 N/ho 0 N/vo 0 N/hsc 1 N/vsc 1 N/ang 0 N/CLIP 0 N/rwiSeen false N
/rhiSeen false N/letter{}N/note{}N/a4{}N/legal{}N}B/@scaleunit 100 N
/@hscale{@scaleunit div/hsc X}B/@vscale{@scaleunit div/vsc X}B/@hsize{
/hs X/CLIP 1 N}B/@vsize{/vs X/CLIP 1 N}B/@clip{/CLIP 2 N}B/@hoffset{/ho
X}B/@voffset{/vo X}B/@angle{/ang X}B/@rwi{10 div/rwi X/rwiSeen true N}B
/@rhi{10 div/rhi X/rhiSeen true N}B/@llx{/llx X}B/@lly{/lly X}B/@urx{
/urx X}B/@ury{/ury X}B/magscale true def end/@MacSetUp{userdict/md known
{userdict/md get type/dicttype eq{userdict begin md length 10 add md
maxlength ge{/md md dup length 20 add dict copy def}if end md begin
/letter{}N/note{}N/legal{}N/od{txpose 1 0 mtx defaultmatrix dtransform S
atan/pa X newpath clippath mark{transform{itransform moveto}}{transform{
itransform lineto}}{6 -2 roll transform 6 -2 roll transform 6 -2 roll
transform{itransform 6 2 roll itransform 6 2 roll itransform 6 2 roll
curveto}}{{closepath}}pathforall newpath counttomark array astore/gc xdf
pop ct 39 0 put 10 fz 0 fs 2 F/|______Courier fnt invertflag{PaintBlack}
if}N/txpose{pxs pys scale ppr aload pop por{noflips{pop S neg S TR pop 1
-1 scale}if xflip yflip and{pop S neg S TR 180 rotate 1 -1 scale ppr 3
get ppr 1 get neg sub neg ppr 2 get ppr 0 get neg sub neg TR}if xflip
yflip not and{pop S neg S TR pop 180 rotate ppr 3 get ppr 1 get neg sub
neg 0 TR}if yflip xflip not and{ppr 1 get neg ppr 0 get neg TR}if}{
noflips{TR pop pop 270 rotate 1 -1 scale}if xflip yflip and{TR pop pop
90 rotate 1 -1 scale ppr 3 get ppr 1 get neg sub neg ppr 2 get ppr 0 get
neg sub neg TR}if xflip yflip not and{TR pop pop 90 rotate ppr 3 get ppr
1 get neg sub neg 0 TR}if yflip xflip not and{TR pop pop 270 rotate ppr
2 get ppr 0 get neg sub neg 0 S TR}if}ifelse scaleby96{ppr aload pop 4
-1 roll add 2 div 3 1 roll add 2 div 2 copy TR .96 dup scale neg S neg S
TR}if}N/cp{pop pop showpage pm restore}N end}if}if}N/normalscale{
Resolution 72 div VResolution 72 div neg scale magscale{DVImag dup scale
}if 0 setgray}N/psfts{S 65781.76 div N}N/startTexFig{/psf$SavedState
save N userdict maxlength dict begin/magscale true def normalscale
currentpoint TR/psf$ury psfts/psf$urx psfts/psf$lly psfts/psf$llx psfts
/psf$y psfts/psf$x psfts currentpoint/psf$cy X/psf$cx X/psf$sx psf$x
psf$urx psf$llx sub div N/psf$sy psf$y psf$ury psf$lly sub div N psf$sx
psf$sy scale psf$cx psf$sx div psf$llx sub psf$cy psf$sy div psf$ury sub
TR/showpage{}N/erasepage{}N/setpagedevice{pop}N/copypage{}N/p 3 def
@MacSetUp}N/doclip{psf$llx psf$lly psf$urx psf$ury currentpoint 6 2 roll
newpath 4 copy 4 2 roll moveto 6 -1 roll S lineto S lineto S lineto
closepath clip newpath moveto}N/endTexFig{end psf$SavedState restore}N
/@beginspecial{SDict begin/SpecialSave save N gsave normalscale
currentpoint TR @SpecialDefaults count/ocount X/dcount countdictstack N}
N/@setspecial{CLIP 1 eq{newpath 0 0 moveto hs 0 rlineto 0 vs rlineto hs
neg 0 rlineto closepath clip}if ho vo TR hsc vsc scale ang rotate
rwiSeen{rwi urx llx sub div rhiSeen{rhi ury lly sub div}{dup}ifelse
scale llx neg lly neg TR}{rhiSeen{rhi ury lly sub div dup scale llx neg
lly neg TR}if}ifelse CLIP 2 eq{newpath llx lly moveto urx lly lineto urx
ury lineto llx ury lineto closepath clip}if/showpage{}N/erasepage{}N
/setpagedevice{pop}N/copypage{}N newpath}N/@endspecial{count ocount sub{
pop}repeat countdictstack dcount sub{end}repeat grestore SpecialSave
restore end}N/@defspecial{SDict begin}N/@fedspecial{end}B/li{lineto}B
/rl{rlineto}B/rc{rcurveto}B/np{/SaveX currentpoint/SaveY X N 1
setlinecap newpath}N/st{stroke SaveX SaveY moveto}N/fil{fill SaveX SaveY
moveto}N/ellipse{/endangle X/startangle X/yrad X/xrad X/savematrix
matrix currentmatrix N TR xrad yrad scale 0 0 1 startangle endangle arc
savematrix setmatrix}N end

%%EndProcSet
TeXDict begin 40258437 52099151 1000 600 600 (nachos.dvi)
@start /Fa 133[44 50 50 72 50 55 33 39 44 1[55 50 55
83 28 55 1[28 55 50 33 44 55 44 55 50 9[100 72 1[66 55
72 1[61 78 1[94 66 2[39 78 1[61 66 72 72 1[72 7[50 50
50 50 50 50 50 50 50 50 1[25 1[25 1[50 33 33 40[{
TeXBase1Encoding ReEncodeFont}55 99.6264 /Times-Bold
rf /Fb 130[55 1[55 55 55 55 55 55 55 55 55 55 55 55 55
55 55 55 55 1[55 55 55 55 55 55 55 55 55 1[55 55 55 55
55 1[55 55 55 55 55 55 55 55 1[55 55 55 55 55 55 1[55
55 55 55 55 55 55 55 55 2[55 55 1[55 55 5[55 1[55 55
55 55 55 55 55 55 55 55 55 55 5[55 33[{TeXBase1Encoding ReEncodeFont}73
90.9091 /Courier rf /Fc 134[40 40 1[40 45 25 35 35 1[45
45 45 66 25 40 1[25 45 45 1[40 45 40 1[45 3[35 1[35 3[76
1[66 51 45 56 1[56 66 61 76 51 61 1[30 66 1[56 56 1[61
56 56 2[61 3[30 10[25 23 30 23 2[30 30 4[45 38 31[45
2[{TeXBase1Encoding ReEncodeFont}51 90.9091 /Times-Italic
rf /Fd 134[45 1[66 2[30 35 40 2[45 51 76 25 2[25 51 1[30
40 51 2[45 11[66 1[51 12[56 70[{TeXBase1Encoding ReEncodeFont}18
90.9091 /Times-Bold rf /Fe 107[40 40 24[40 45 45 66 45
45 25 35 30 45 45 45 45 71 25 45 25 25 45 45 30 40 45
40 45 40 1[45 5[66 66 86 66 66 56 51 61 1[51 66 66 81
56 66 35 30 66 1[51 56 66 61 61 66 5[25 25 45 45 45 45
45 45 45 45 45 45 25 23 30 23 2[30 30 30 36[51 2[{
TeXBase1Encoding ReEncodeFont}72 90.9091 /Times-Roman
rf /Ff 134[60 60 86 1[66 40 47 53 1[66 60 66 100 33 66
1[33 66 60 1[53 66 53 1[60 11[86 80 66 86 1[73 1[86 113
3[47 4[86 86 9[60 60 60 60 60 60 60 60 60 60 33 1[40
45[{TeXBase1Encoding ReEncodeFont}42 119.552 /Times-Bold
rf /Fg 134[50 1[72 50 50 28 39 33 2[50 50 78 28 50 1[28
50 50 1[44 50 1[50 44 13[55 66 1[55 2[89 4[72 6[72 9[50
1[50 2[50 50 50 3[25 41[55 2[{TeXBase1Encoding ReEncodeFont}32
99.6264 /Times-Roman rf /Fh 140[56 3[72 6[80 4[64 1[72
18[104 78[{TeXBase1Encoding ReEncodeFont}6 143.462 /Times-Bold
rf end
%%EndProlog
%%BeginSetup
%%Feature: *Resolution 600dpi
TeXDict begin
%%BeginPaperSize: Letter
letter
%%EndPaperSize
 end
%%EndSetup
%%Page: 1 1
TeXDict begin 1 0 bop 1727 456 a Fh(Nachos)1087 708 y
Fg(Matthe)n(w)24 b(Peters,)h(Robert)g(Hill,)f(Shyam)g(P)o(ather)1179
825 y(Modi\002ed)g(by)h(Si)n(v)n(asankar)f(Ponnambalam)1619
1026 y(August)g(17,)g(2005)0 1418 y Ff(1)119 b(Intr)n(oduction)0
1625 y Fe(Nachos)30 b(is)f(a)g(multitasking)j(operating)g(system)e
(simulation)i(that)e(runs)g(in)f(a)g(single)i(Unix)e(process.)48
b(It)29 b(implements)i(a)0 1738 y(multi-process)g(model)d(by)h(using)g
(user)n(-le)n(v)o(el)h(threads;)i(each)d(user)n(-le)n(v)o(el)h(process)
g(has)e(a)g(Nachos)g(k)o(ernel)i(thread)f(asso-)0 1851
y(ciated)e(with)f(it)g(to)g(pro)o(vide)h(a)f(conte)o(xt)h(for)f(e)o(x)o
(ecuting)i(the)e(processor)j(\(In)d(this)g(case,)h(a)f(MIPS)e
(simulator\).)38 b(Thus,)26 b(each)0 1964 y(user)n(-le)n(v)o(el)g
(thread)f(is)e(vie)n(wed)h(as)f(a)h(process)h(under)g(Nachos.)141
2077 y(From)31 b(\002gure)h(1)f(belo)n(w)g(you)h(can)g(see)g(the)g(o)o
(v)o(erall)g(structure)i(of)d(Nachos.)54 b(Each)31 b(thread)i
(\(indicated)h(by)e(T1,)g(T2,)0 2190 y(and)26 b(so)g(on\))g(is)g(an)f
(independent)30 b(thread)d(of)e(control)j(in)e(the)g(Nachos)g
(operating)i(system.)37 b(F)o(or)24 b(the)i(most)g(part,)h(the)o(y)f
(can)0 2303 y(be)i(vie)n(wed)h(as)f(processes,)k(only)d(on)f(a)g
(smaller)h(scale.)44 b(It)28 b(should)i(be)e(noted)h(that)g
Fd(all)g Fe(of)f(the)g(internals)j(of)d(the)g(Nachos)0
2416 y(program)d(are)e(in)l(visible)k(to)c(Unix)h(while)f(running;)j(T)
-7 b(o)23 b(Unix,)g(Nachos)h(is)g(just)g(another)h(process.)600
4586 y @beginspecial 0 @llx 0 @lly 441 @urx 335 @ury
3240 @rwi @setspecial
%%BeginDocument: figures/nachos1.eps
%!PS-Adobe-2.0 EPSF
%%Title: /tmp/xfig-fig000712
%%Creator: fig2dev
%%CreationDate: Wed Oct 30 20:54:33 1996
%%For: rhill@dante (Robert Hill)
%%BoundingBox: 0 0 441 335
%%Pages: 0
%%EndComments
/$F2psDict 200 dict def 
$F2psDict begin
$F2psDict /mtrx matrix put
/l {lineto} bind def
/m {moveto} bind def
/s {stroke} bind def
/n {newpath} bind def
/gs {gsave} bind def
/gr {grestore} bind def
/clp {closepath} bind def
/graycol {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
4 -2 roll mul setrgbcolor} bind def
/col-1 {} def
/col0 {0 0 0 setrgbcolor} bind def
/col1 {0 0 1 setrgbcolor} bind def
/col2 {0 1 0 setrgbcolor} bind def
/col3 {0 1 1 setrgbcolor} bind def
/col4 {1 0 0 setrgbcolor} bind def
/col5 {1 0 1 setrgbcolor} bind def
/col6 {1 1 0 setrgbcolor} bind def
/col7 {1 1 1 setrgbcolor} bind def
	end
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def
%%EndProlog

$F2psBegin
0 setlinecap 0 setlinejoin
-49.0 423.0 translate 0.900 -0.900 scale
0.500 setlinewidth
% Polyline
n 544 469 m 544 120 l  54 120 l  54 469 l 
 clp gs col-1 s gr
% Polyline
n 347 210 m 347 149 l  285 149 l  285 210 l 
 clp gs col-1 s gr
% Polyline
n 455 210 m 455 149 l  394 149 l  394 210 l 
 clp gs col-1 s gr
% Polyline
n 455 300 m 455 239 l  394 239 l  394 300 l 
 clp gs col-1 s gr
% Polyline
n 455 396 m 455 334 l  394 334 l  394 396 l 
 clp gs col-1 s gr
% Polyline
n 244 300 m 244 149 l  74 149 l  74 300 l 
 clp gs col-1 s gr
% Polyline
n 204 239 m 265 239 l  265 171 l  300 171 l gs col-1 s gr
n 292.000 169.000 m 300.000 171.000 l 292.000 173.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 204 267 m 278 267 l  278 194 l  300 194 l gs col-1 s gr
n 292.000 192.000 m 300.000 194.000 l 292.000 196.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 88 323 m 81 323 81 350 7 arcto 4 {pop} repeat 81 357 237 357 7 arcto 4 {pop} repeat 244 357 244 330 7 arcto 4 {pop} repeat 244 323 88 323 7 arcto 4 {pop} repeat clp gs col-1 s gr
% Polyline
n 157 345 m 157 379 l gs col-1 s gr
n 159.000 371.000 m 157.000 379.000 l 155.000 371.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 95 373 m 88 373 88 456 7 arcto 4 {pop} repeat 88 463 293 463 7 arcto 4 {pop} repeat 300 463 300 380 7 arcto 4 {pop} repeat 300 373 95 373 7 arcto 4 {pop} repeat clp gs col-1 s gr
% Polyline
n 224 413 m 313 413 l  313 210 l gs col-1 s gr
n 311.000 218.000 m 313.000 210.000 l 315.000 218.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 224 441 m 360 441 l  360 250 l  387 250 l gs col-1 s gr
n 379.000 248.000 m 387.000 250.000 l 379.000 252.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 360 357 m 387 357 l gs col-1 s gr
n 379.000 355.000 m 387.000 357.000 l 379.000 359.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 143 250 m 143 233 l  217 233 l  217 250 l 
 clp gs col-1 s gr
% Polyline
n 143 277 m 143 260 l  217 260 l  217 277 l 
 clp gs col-1 s gr
/Times-Roman findfont 17.00 scalefont setfont
88 109 m 
gs 1 -1 scale (Nachos) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
88 177 m 
gs 1 -1 scale (MIPS Simulator) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
292 143 m 
gs 1 -1 scale (T1) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
101 396 m 
gs 1 -1 scale (Scheduler) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
95 345 m 
gs 1 -1 scale (Timer) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
401 194 m 
gs 1 -1 scale (Waiting) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
401 283 m 
gs 1 -1 scale (Ready) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
401 379 m 
gs 1 -1 scale (Ready) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
101 418 m 
gs 1 -1 scale (CurrentThread) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
101 447 m 
gs 1 -1 scale (ReadyList) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
408 144 m 
gs 1 -1 scale (T2) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
408 234 m 
gs 1 -1 scale (T4) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
408 329 m 
gs 1 -1 scale (T6) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
150 275 m 
gs 1 -1 scale (SP) col-1 show gr
/Times-Roman findfont 17.00 scalefont setfont
150 248 m 
gs 1 -1 scale (PC) col-1 show gr
$F2psEnd

%%EndDocument
 @endspecial 1190 4782 a(Figure)f(1:)29 b(Structure)c(of)e(the)h
(Nachos)g(Process)141 4995 y(Unlik)o(e)k(a)f(real)g(operating)j
(system,)e(Nachos)g(doesn')n(t)h(run)f(on)f(bare)h(hardw)o(are.)41
b(T)-7 b(o)26 b(simulate)i(the)f(lo)n(w-le)n(v)o(el)h(func-)0
5108 y(tions)34 b(of)f(interrupts,)38 b(clocks)c(and)g(re)o(gisters,)j
(the)c(Nachos)h(operating)h(system)f(simulates)h(a)d(MIPS)g(processor)
-5 b(.)59 b(This)0 5221 y(processor)30 b(is)e(capable)h(of)f
(performing)i(the)d(same)h(jobs)g(a)g(normal)g(processor)i(w)o(ould,)f
(including)h(e)o(x)o(ecuting)g(arbitrary)0 5334 y(instructions)d(from)c
(a)h(user)g(program.)1927 5649 y(1)p eop end
%%Page: 2 2
TeXDict begin 2 1 bop 141 91 a Fe(The)31 b(Nachos)i(system)f(can)h(run)
f(in)f(tw)o(o)h(modes:)46 b Fd(User)32 b(mode)p Fe(,)g(and)h
Fd(System)e(mode)p Fe(.)53 b(In)31 b Fc(user)i(mode)f
Fe(the)g(MIPS)0 204 y(simulator)h(is)f(spinning)i(through)g(a)e(series)
h(of)f(fetch-e)o(x)o(ecute)i(c)o(ycles)f(on)f(a)g(user)g(program.)55
b(Nachos)33 b(e)o(x)o(ecutes)g(user)n(-)0 317 y(le)n(v)o(el)26
b(processes)j(by)d(loading)i(them)e(into)g(the)h(simulator')-5
b(s)28 b(memory)-6 b(,)27 b(initializing)i(the)d(simulator')-5
b(s)28 b(re)o(gisters)g(and)e(then)0 430 y(running)i(the)e(simulator)-5
b(.)38 b(User)n(-programs)28 b(can)f(only)f(access)i(the)e(memory)g
(associated)j(with)c(the)i(simulated)g(machine.)0 543
y(The)d(fetch-e)o(x)o(ecute)j(c)o(ycle)e(is)f(carried)i(out)e(until)i
(a)d(system)i(trap)g(occurs,)h(either)f(as)f(the)h(result)g(of)f(an)g
(e)o(xpired)i(quantum,)0 656 y(an)d(ille)o(gal)h(instruction,)i(a)d
(page)h(f)o(ault,)g(or)f(a)g(system)h(call.)29 b(Nachos)24
b(switches)g(into)g Fc(system)g(mode)f Fe(at)g(this)h(point)g(or)f
(when)0 769 y(it)31 b(starts)i(up.)53 b(In)31 b(the)h
Fc(system)g(mode)p Fe(,)h(Nachos)g(e)o(x)o(ecutes)g(the)e(w)o(ay)h
(normal)g(Unix)f(processes)j(e)o(x)o(ecutes.)55 b(That)31
b(is,)i(the)0 882 y(statements)25 b(corresponding)h(to)d(the)g(Nachos)g
(source)h(code)g(are)f(e)o(x)o(ecuted,)h(and)f(the)g(memory)f(accessed)
j(corresponds)h(to)0 995 y(the)e(memory)g(assigned)h(to)f(the)g(Nachos)
g(v)n(ariables.)141 1108 y(It)g(should)i(be)e(noted)i(that)e(while)h
(user)g(programs)g(in)g(Nachos)g(are)f(run)h(on)f(the)g(simulated)i
(MIPS)d(machine,)i(System)0 1220 y(Mode)f(transactions)j(are)d
(performed)h(directly)g(on)f(the)g(host)g(machine)h(\(in)f(this)g
(case,)g(an)f(x86\).)0 1511 y Ff(2)119 b(Machine)31 b(Setup)0
1718 y Fe(The)e(simulated)h(MIPS)e(processor)j(consists)g(of)e(a)g(set)
g(of)g(re)o(gisters)h(\(implemented)i(in)c(softw)o(are)j(as)e(an)g
(array)g(of)g(inte-)0 1831 y(gers\),)e(a)e(bank)h(of)f(main)h(memory)-6
b(,)26 b(and)g(a)f(set)g(of)h(simple)g(read)g(and)g(write)f
(instructions.)38 b(In)26 b(addition,)h(an)f(e)n(v)o(ent-dri)n(v)o(en)0
1944 y(simulated)21 b(clock)g(pro)o(vides)h(a)d(mechanism)i(to)f
(schedule)i(interrupts)h(and)d(e)o(x)o(ecute)h(them)e(at)h(a)f(later)i
(time.)27 b(The)19 b(simulated)0 2057 y(MIPS)j(machine)j(can)f(e)o(x)o
(ecute)g(arbitrary)i(programs.)k(A)23 b(conceptual)j(vie)n(w)d(of)h
(this)g(is)f(sho)n(wn)h(in)f(Figure)i(2.)600 3890 y @beginspecial
0 @llx 0 @lly 563 @urx 358 @ury 3240 @rwi @setspecial
%%BeginDocument: figures/nachos6.eps
%!PS-Adobe-2.0 EPSF
%%Title: /tmp/xfig-fig000712
%%Creator: fig2dev
%%CreationDate: Wed Oct 30 20:47:29 1996
%%For: rhill@dante (Robert Hill)
%%BoundingBox: 0 0 563 358
%%Pages: 0
%%EndComments
/$F2psDict 200 dict def 
$F2psDict begin
$F2psDict /mtrx matrix put
/l {lineto} bind def
/m {moveto} bind def
/s {stroke} bind def
/n {newpath} bind def
/gs {gsave} bind def
/gr {grestore} bind def
/clp {closepath} bind def
/graycol {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
4 -2 roll mul setrgbcolor} bind def
/col-1 {} def
/col0 {0 0 0 setrgbcolor} bind def
/col1 {0 0 1 setrgbcolor} bind def
/col2 {0 1 0 setrgbcolor} bind def
/col3 {0 1 1 setrgbcolor} bind def
/col4 {1 0 0 setrgbcolor} bind def
/col5 {1 0 1 setrgbcolor} bind def
/col6 {1 1 0 setrgbcolor} bind def
/col7 {1 1 1 setrgbcolor} bind def
	end
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def
%%EndProlog

$F2psBegin
0 setlinecap 0 setlinejoin
-49.0 503.0 translate 0.900 -0.900 scale
0.500 setlinewidth
% Polyline
n 519 534 m 519 209 l  209 209 l  209 534 l 
 clp gs col-1 s gr
% Polyline
n 509 464 m 509 374 l  219 374 l  219 464 l 
 clp gs col-1 s gr
% Polyline
n 509 524 m 509 474 l  219 474 l  219 524 l 
 clp gs col-1 s gr
% Polyline
n 509 364 m 509 224 l  364 224 l  364 364 l 
 clp gs col-1 s gr
% Polyline
n 359 239 m 359 219 l  214 219 l  214 239 l 
 clp gs col-1 s gr
% Polyline
n 359 264 m 359 244 l  214 244 l  214 264 l 
 clp gs col-1 s gr
% Polyline
n 359 289 m 359 269 l  214 269 l  214 289 l 
 clp gs col-1 s gr
% Polyline
n 359 314 m 359 294 l  214 294 l  214 314 l 
 clp gs col-1 s gr
% Polyline
n 359 339 m 359 319 l  214 319 l  214 339 l 
 clp gs col-1 s gr
% Polyline
n 359 364 m 359 344 l  214 344 l  214 364 l 
 clp gs col-1 s gr
% Polyline
n 509 279 m 509 259 l  364 259 l  364 279 l 
 clp gs col-1 s gr
% Polyline
n 509 299 m 509 279 l  364 279 l  364 299 l 
 clp gs col-1 s gr
% Polyline
n 509 319 m 509 299 l  364 299 l  364 319 l 
 clp gs col-1 s gr
% Polyline
n 509 339 m 509 319 l  364 319 l  364 339 l 
 clp gs col-1 s gr
% Polyline
n 509 359 m 509 339 l  364 339 l  364 359 l 
 clp gs col-1 s gr
% Polyline
n 434 259 m 434 359 l  429 359 l gs col-1 s gr
% Polyline
n 234 464 m 234 374 l  219 374 l  219 464 l 
 clp gs col-1 s gr
% Polyline
n 249 464 m 249 374 l  234 374 l  234 464 l 
 clp gs col-1 s gr
% Polyline
n 264 464 m 264 374 l  249 374 l  249 464 l 
 clp gs col-1 s gr
% Polyline
n 279 464 m 279 374 l  264 374 l  264 464 l 
 clp gs col-1 s gr
% Polyline
n 459 464 m 459 374 l  444 374 l  444 464 l 
 clp gs col-1 s gr
% Polyline
n 474 464 m 474 374 l  459 374 l  459 464 l 
 clp gs col-1 s gr
% Polyline
n 489 464 m 489 374 l  474 374 l  474 464 l 
 clp gs col-1 s gr
% Polyline
n 504 464 m 504 374 l  489 374 l  489 464 l 
 clp gs col-1 s gr
% Polyline
n 444 429 m 444 399 l  279 399 l  279 429 l 
 clp gs col-1 s gr
% Polyline
n 294 399 m 294 374 l  279 374 l  279 399 l 
 clp gs col-1 s gr
% Polyline
n 309 399 m 309 374 l  294 374 l  294 399 l 
 clp gs col-1 s gr
% Polyline
n 324 399 m 324 374 l  309 374 l  309 399 l 
 clp gs col-1 s gr
% Polyline
n 339 399 m 339 374 l  324 374 l  324 399 l 
 clp gs col-1 s gr
% Polyline
n 354 399 m 354 374 l  339 374 l  339 399 l 
 clp gs col-1 s gr
% Polyline
n 369 399 m 369 374 l  354 374 l  354 399 l 
 clp gs col-1 s gr
% Polyline
n 384 399 m 384 374 l  369 374 l  369 399 l 
 clp gs col-1 s gr
% Polyline
n 399 399 m 399 374 l  384 374 l  384 399 l 
 clp gs col-1 s gr
% Polyline
n 414 399 m 414 374 l  399 374 l  399 399 l 
 clp gs col-1 s gr
% Polyline
n 429 399 m 429 374 l  414 374 l  414 399 l 
 clp gs col-1 s gr
% Polyline
n 294 464 m 294 429 l  279 429 l  279 464 l 
 clp gs col-1 s gr
% Polyline
n 309 464 m 309 429 l  294 429 l  294 464 l 
 clp gs col-1 s gr
% Polyline
n 324 464 m 324 429 l  309 429 l  309 464 l 
 clp gs col-1 s gr
% Polyline
n 339 464 m 339 429 l  324 429 l  324 464 l 
 clp gs col-1 s gr
% Polyline
n 354 464 m 354 429 l  339 429 l  339 464 l 
 clp gs col-1 s gr
% Polyline
n 369 464 m 369 429 l  354 429 l  354 464 l 
 clp gs col-1 s gr
% Polyline
n 384 464 m 384 429 l  369 429 l  369 464 l 
 clp gs col-1 s gr
% Polyline
n 399 464 m 399 429 l  384 429 l  384 464 l 
 clp gs col-1 s gr
% Polyline
n 414 464 m 414 429 l  399 429 l  399 464 l 
 clp gs col-1 s gr
% Polyline
n 429 464 m 429 429 l  414 429 l  414 464 l 
 clp gs col-1 s gr
% Polyline
n 399 399 m 399 374 l  384 374 l  384 399 l 
 clp gs col-1 s gr
% Polyline
n 399 399 m 399 374 l  384 374 l  384 399 l 
 clp gs col-1 s gr
/Times-Roman findfont 14.00 scalefont setfont
224 284 m 
gs 1 -1 scale (Register) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
224 309 m 
gs 1 -1 scale (Register) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
224 334 m 
gs 1 -1 scale (Register) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
224 359 m 
gs 1 -1 scale (Register) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
224 234 m 
gs 1 -1 scale (Program Counter) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
224 259 m 
gs 1 -1 scale (Register) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
379 244 m 
gs 1 -1 scale (Page Table) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
374 274 m 
gs 1 -1 scale (VPN: 0) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
374 294 m 
gs 1 -1 scale (VPN: 1) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
374 314 m 
gs 1 -1 scale (VPN: 2) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
374 334 m 
gs 1 -1 scale (VPN: 3) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
374 354 m 
gs 1 -1 scale (VPN: 4) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
444 274 m 
gs 1 -1 scale (PPN: 3) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
444 294 m 
gs 1 -1 scale (PPN: 9) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
444 314 m 
gs 1 -1 scale (PPN: 51) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
444 334 m 
gs 1 -1 scale (PPN: 2) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
444 354 m 
gs 1 -1 scale (PPN: 15) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
299 419 m 
gs 1 -1 scale (Main Memory \(16K\)) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
229 494 m 
gs 1 -1 scale (Timer) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
229 514 m 
gs 1 -1 scale (Systemticks 339392   UserTicks 27182837) col-1 show gr
n 197.240 323.723 m 204.000 319.000 l 200.258 326.348 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 145.316 267.947 77.783 156.470 41.022 arcn
gs col-1 s gr
	[] 0 setdash
n 88.649 242.189 m 84.000 249.000 l 84.897 240.803 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 141.500 270.250 61.301 -20.283 -159.717 arcn
gs col-1 s gr
	[] 0 setdash
n 594.757 386.929 m 599.000 394.000 l 591.929 389.757 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 561.500 431.500 53.033 -45.000 -135.000 arcn
gs col-1 s gr
	[] 0 setdash
n 528.498 440.911 m 524.000 434.000 l 531.221 437.982 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 564.577 390.346 59.600 54.720 132.908 arc
gs col-1 s gr
	[] 0 setdash
n 496.509 265.591 m 489.000 269.000 l 494.021 262.459 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 455.250 226.500 54.271 51.546 -51.546 arcn
gs col-1 s gr
	[] 0 setdash
n 371.113 186.408 m 379.000 184.000 l 373.174 189.836 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 405.579 228.211 51.585 127.747 -121.014 arc
gs col-1 s gr
	[] 0 setdash
n 605.754 554.015 m 614.000 554.000 l 606.731 557.894 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 586.500 444.833 112.577 145.251 75.861 arcn
gs col-1 s gr
	[] 0 setdash
n 507.130 487.622 m 499.000 489.000 l 505.525 483.958 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 545.840 595.934 116.742 -44.575 -113.655 arcn
gs col-1 s gr
	[] 0 setdash
/Times-Roman findfont 14.00 scalefont setfont
54 274 m 
gs 1 -1 scale (ReadReg\(\)) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
54 294 m 
gs 1 -1 scale (WriteReg\(\)) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
559 414 m 
gs 1 -1 scale (ReadMem\(\)) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
559 434 m 
gs 1 -1 scale (WriteMem\(\)) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
384 174 m 
gs 1 -1 scale (Translate\(vpn, ppn\)) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
619 554 m 
gs 1 -1 scale (Interrupt\(\)) col-1 show gr
/Times-Roman findfont 14.00 scalefont setfont
619 529 m 
gs 1 -1 scale (OneTick\(\)) col-1 show gr
$F2psEnd

%%EndDocument
 @endspecial 1166 4086 a(Figure)f(2:)29 b(Machine)c(Functions)g(and)f
(Structure)141 4295 y(When)c(a)g(program)h(is)e(loaded)j(into)e(memory)
g(the)h(Nachos)f(operating)j(system)d(reads)h(the)f(contents)i(of)e
(the)g(program')-5 b(s)0 4408 y(e)o(x)o(ecutable)33 b(\002le)c(from)i
(disk,)h(then)f(writes)g(those)g(contents)i(into)e(main)f(memory)-6
b(.)50 b(This)30 b(is)g(done)i(one)e(byte)i(at)e(a)g(time.)0
4521 y(Once)k(the)h(contents)i(of)d(the)h(e)o(x)o(ecutable)h(are)f(in)f
(memory)h(and)g(the)g(program)g(counter)h(is)f(set,)i(the)d(machine)i
(be)o(gins)0 4633 y(e)o(x)o(ecution)25 b(by)f(calling)h
Fc(Mac)o(hine::Run\(\))h Fe(\(located)g(in)d Fc(mac)o(hine/mipssim.cc)p
Fe(\).)141 4746 y(The)g(structure)j(of)d(the)h(MIPS)e(machine)j(can)f
(be)f(seen)i(belo)n(w:)0 4948 y Fb(class)52 b(Machine)g({)109
5061 y(public:)55 5174 y(/)110 5190 y(*)218 5174 y(Routines)f(CALLABLE)
g(by)j(the)f(Nachos)f(Kernel.)2400 5190 y(*)2455 5174
y(/)218 5287 y(/)273 5303 y(*)382 5287 y(Run)h(a)h(user)f(program)1418
5303 y(*)1473 5287 y(/)545 5400 y(void)g(Run\(\);)1927
5649 y Fe(2)p eop end
%%Page: 3 3
TeXDict begin 3 2 bop 218 91 a Fb(/)273 107 y(*)382 91
y(Read)53 b(the)g(contents)e(of)i(a)h(CPU)g(register)2345
107 y(*)2400 91 y(/)545 204 y(int)g(ReadRegister\(i)o(nt)48
b(num\);)218 317 y(/)273 333 y(*)382 317 y(Store)k(a)i(value)e(into)h
(a)h(CPU)f(register)2236 333 y(*)2291 317 y(/)545 430
y(void)g(WriteRegister\(i)o(nt)48 b(num,)53 b(int)g(value\);)218
543 y(/)273 559 y(*)382 543 y(Sets)g(register)d(to)k(state)e(acquired)f
(if)j(operating)c(system)i(was)382 656 y(executing)e(on)k(simulated)c
(hardware)2127 672 y(*)2182 656 y(/)545 769 y(void)j(Fix_Fork_Regist)o
(er)o(\(\);)0 882 y(/)55 898 y(*)164 882 y(Routines)e(internal)f(to)k
(Machine)d(simulation)f(--)k(NOT)f(CALLABLE.)3273 898
y(*)3328 882 y(/)218 995 y(/)273 1011 y(*)382 995 y(Run)g(one)g
(instruction)d(of)j(a)h(user)f(program)2455 1011 y(*)2510
995 y(/)545 1108 y(void)g(OneInstruction\()o(In)o(str)o(uc)o(ti)o(on)
2291 1123 y(*)2346 1108 y(instr\);)218 1220 y(/)273 1236
y(*)382 1220 y(Simulate)e(effects)g(of)j(Delayed)d(Load)2182
1236 y(*)2237 1220 y(/)545 1333 y(void)i(DelayedLoad\(int)48
b(nextReg,)j(int)i(nextVal\);)218 1446 y(/)273 1462 y(*)382
1446 y(Read)g(or)g(write)f(1,)i(2,)g(or)f(4)h(bytes)f(of)g(virtual)f
(memory)g(\(at)h(addr\))3600 1462 y(*)3655 1446 y(/)218
1559 y(/)273 1575 y(*)382 1559 y(Return)f(false)g(if)i(a)g(correct)d
(translation)f(couldn't)g(be)k(found)3436 1575 y(*)3491
1559 y(/)545 1672 y(bool)f(ReadMem\(int)d(addr,)i(int)h(size,)f(int)
2510 1688 y(*)2618 1672 y(value\);)545 1785 y(bool)h(WriteMem\(int)c
(addr,)k(int)g(size,)f(int)h(value\);)218 1898 y(/)273
1914 y(*)382 1898 y(Translate)d(an)k(address,)d(and)i(check)f(for)h
(alignment)2891 1914 y(*)2946 1898 y(/)545 2011 y(ExceptionType)c
(Translate\(int)g(virtAddr,)h(int)2783 2027 y(*)2891
2011 y(physAddr,)g(int)k(size\);)218 2124 y(/)273 2140
y(*)382 2124 y(Trap)f(to)g(the)g(Nachos)f(kernel,)g(because)f(of)j(a)g
(system)d(call)i(or)h(other)e(exception.)4309 2140 y(*)4364
2124 y(/)545 2237 y(void)h(RaiseException\()o(Ex)o(cep)o(ti)o(on)o(Ty)o
(pe)48 b(which,)k(int)h(badVAddr\);)218 2350 y(/)273
2365 y(*)382 2350 y(Physical)e(memory)h(to)h(store)f(a)j(user)d
(program,)f(code)i(and)g(data)g(while)f(executing.)4309
2365 y(*)4364 2350 y(/)545 2462 y(char)818 2478 y(*)873
2462 y(mainMemory;)218 2575 y(/)273 2591 y(*)382 2575
y(CPU)h(registers,)d(for)j(executing)e(user)h(programs)2727
2591 y(*)2782 2575 y(/)545 2688 y(int)i(registers[NumT)o(ot)o(al)o(Reg)
o(s])o(;)218 2801 y(/)273 2817 y(*)382 2801 y(Pointer)d(to)j(Page)f
(Table)1636 2817 y(*)1691 2801 y(/)545 2914 y(TranslationEntry)1473
2930 y(*)1528 2914 y(pageTable;)0 3027 y(};)0 3276 y
Fa(2.1)99 b(Main)25 b(Memory)0 3450 y Fe(In)35 b(the)h(MIPS)d
(simulator)l(,)40 b(main)35 b(memory)h(is)f(implemented)i(as)e(an)g
(array)i(of)e(bytes.)65 b(This)35 b(array)h(is)f(written)h(to)f(by)0
3563 y(the)d(instruction)j Fc(WriteMem\(\))p Fe(,)f(and)e(is)g(read)g
(by)g(the)g(instruction)j Fc(ReadMem\(\))p Fe(.)53 b(Memory)32
b(is)g(byte-addressable)37 b(and)0 3676 y(or)n(ganized)c(into)d
(128-byte)j(pages,)f(the)e(same)g(size)h(as)f(disk)g(sectors.)50
b(Memory)30 b(corresponding)35 b(to)30 b(physical)h(address)0
3789 y(x)e(can)g(be)g(accessed)i(in)e(Nachos)g(at)57
b Fc(mac)o(hine)30 b(CHH)d(->mainMemory[x])p Fe(.By)k(def)o(ault,)h
(the)d(Nachos)h(MIPS)d(machine)0 3902 y(has)k(31)g(pages)h(of)e
(physical)j(memory)-6 b(.)50 b(The)30 b(actual)i(number)g(of)e(pages)i
(used)f(is)g(controlled)i(by)e(the)g(NumPhysP)o(ages)0
4015 y(v)n(ariable)25 b(in)f(machine.h.)31 b(Inside)25
b(the)f(machine)h(object)g(is)e(a)g(pointer)j(to)e(a)f(page)h(table,)h
(which)f(is)f(a)h(table)g(of)g(translations)0 4128 y(from)30
b(virtual)h(addresses)i(to)d(physical)h(addresses.)51
b(An)29 b(e)o(x)o(ecuting)j(instruction)h(which)d(references)i(a)e
(virtual)h(address)0 4241 y(must)20 b(\002rst)g(ha)n(v)o(e)h(that)g
(virtual)g(address)h(translated)h(into)e(a)f(physical)i(address)g(via)e
Fc(T)-5 b(r)o(anslate\(\))23 b Fe(\(which)d(refers)i(to)e(the)g(page)0
4354 y(table\))25 b(before)g(it)e(can)h(be)f(e)o(x)o(ecuted.)141
4467 y(This)g(translation)k(step)d(during)h(the)f(fetch-e)o(x)o(ecute)j
(c)o(ycle)d(is)f(sho)n(wn)h(belo)n(w:)0 4716 y Fa(2.2)99
b(V)l(irtual)25 b(Memory)0 4890 y Fe(Nachos)36 b(supports)h(VM)d
(through)j(either)f(a)e(single)j(linear)f(page)g(table)g(or)f(a)f
(softw)o(are-managed)39 b(TLB)33 b(\(though)k(not)0 5003
y(simultaneously\).)f(The)24 b(choice)j(of)d(which)h(is)g(in)f(ef)n
(fect)i(is)e(controlled)k(by)d(initializing)i(the)e(tlb)g(or)g(pageT)-7
b(able)26 b(v)n(ariables)0 5116 y(of)34 b(the)f(machine)i(class.)60
b(When)34 b(e)o(x)o(ecuting)i(instructions,)j(the)34
b(Machine)h(object)g(uses)f(whiche)n(v)o(er)h(is)f(de\002ned,)i(after)0
5229 y(v)o(erifying)26 b(that)e(the)o(y)g(are)f(not)h(both)h(set)e
(simultaneously)-6 b(.)141 5342 y(The)23 b(Machine)i(object)g(pro)o
(vides)g(the)f(follo)n(wing)h(operations:)1927 5649 y(3)p
eop end
%%Page: 4 4
TeXDict begin 4 3 bop 300 2667 a @beginspecial 0 @llx
0 @lly 579 @urx 468 @ury 3960 @rwi @setspecial
%%BeginDocument: figures/nachos4.eps
%!PS-Adobe-2.0 EPSF
%%Title: /tmp/xfig-fig000712
%%Creator: fig2dev
%%CreationDate: Wed Oct 30 20:47:06 1996
%%For: rhill@dante (Robert Hill)
%%BoundingBox: 0 0 579 468
%%Pages: 0
%%EndComments
/$F2psDict 200 dict def 
$F2psDict begin
$F2psDict /mtrx matrix put
/l {lineto} bind def
/m {moveto} bind def
/s {stroke} bind def
/n {newpath} bind def
/gs {gsave} bind def
/gr {grestore} bind def
/clp {closepath} bind def
/graycol {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
4 -2 roll mul setrgbcolor} bind def
/col-1 {} def
/col0 {0 0 0 setrgbcolor} bind def
/col1 {0 0 1 setrgbcolor} bind def
/col2 {0 1 0 setrgbcolor} bind def
/col3 {0 1 1 setrgbcolor} bind def
/col4 {1 0 0 setrgbcolor} bind def
/col5 {1 0 1 setrgbcolor} bind def
/col6 {1 1 0 setrgbcolor} bind def
/col7 {1 1 1 setrgbcolor} bind def
	end
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def
%%EndProlog

$F2psBegin
0 setlinecap 0 setlinejoin
-71.0 549.0 translate 0.900 -0.900 scale
0.500 setlinewidth
n 573.939 123.741 m 581.000 128.000 l 572.765 127.565 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 513.208 348.896 231.064 -123.403 -72.939 arc
gs col-1 s gr
	[] 0 setdash
n 395.979 175.573 m 391.000 169.000 l 398.487 172.457 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 471.447 69.026 128.322 34.658 128.823 arc
gs col-1 s gr
	[] 0 setdash
n 501.231 488.061 m 499.000 496.000 l 497.233 487.945 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 152.401 485.933 346.745 -55.259 1.664 arc
gs col-1 s gr
	[] 0 setdash
n 340.267 213.214 m 341.000 205.000 l 344.219 212.592 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 858.726 123.556 524.093 134.713 171.060 arc
gs col-1 s gr
	[] 0 setdash
% Polyline
n 209 609 m 209 505 l  91 505 l  91 609 l 
 clp gs col-1 s gr
% Polyline
n 327 505 m 327 609 l  209 609 l  209 505 l 
 clp gs col-1 s gr
% Polyline
n 563 505 m 563 609 l  445 609 l  445 505 l 
 clp gs col-1 s gr
% Polyline
n 681 505 m 681 609 l  563 609 l  563 505 l 
 clp gs col-1 s gr
% Polyline
n 363 505 m 354 514 l  363 518 l  359 523 l 
 363 527 l  359 536 l  363 541 l  359 550 l  363 554 l 
 359 564 l  368 568 l gs col-1 s gr
n 368 568 m 359 577 l  363 577 l  359 591 l 
 368 591 l  359 600 l  368 604 l  359 609 l gs col-1 s gr
% Polyline
n 422 505 m 413 514 l  422 518 l  413 523 l 
 418 527 l  413 536 l  422 541 l  413 550 l  422 554 l 
 418 564 l  422 568 l gs col-1 s gr
n 422 568 m 413 577 l  422 582 l  413 591 l 
 427 595 l  418 600 l  427 604 l  422 609 l gs col-1 s gr
% Polyline
n 363 505 m 323 505 l  327 505 l gs col-1 s gr
% Polyline
n 359 609 m 323 609 l gs col-1 s gr
% Polyline
n 445 609 m 422 609 l gs col-1 s gr
% Polyline
n 445 505 m 418 505 l gs col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 418 505 m 359 505 l gs col-1 s gr
	[] 0 setdash
	[4.000000] 0 setdash
% Polyline
n 422 609 m 354 609 l gs col-1 s gr
	[] 0 setdash
% Polyline
n 268 554 m 268 505 l  209 505 l  209 554 l 
 clp gs col-1 s gr
% Polyline
n 504 554 m 504 505 l  445 505 l  445 554 l 
 clp gs col-1 s gr
% Polyline
n 622 554 m 622 505 l  563 505 l  563 554 l 
 clp gs col-1 s gr
% Polyline
n 150 554 m 150 505 l  91 505 l  91 554 l 
 clp gs col-1 s gr
% Polyline
n 268 554 m 268 505 l  209 505 l  209 554 l 
 clp gs col-1 s gr
% Polyline
n 504 554 m 504 505 l  445 505 l  445 554 l 
 clp gs col-1 s gr
% Polyline
n 622 554 m 622 505 l  563 505 l  563 554 l 
 clp gs col-1 s gr
% Polyline
n 400 283 m 400 142 l  277 142 l  277 283 l 
 clp gs col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 309 205 m 232 205 l gs col-1 s gr
	[] 0 setdash
n 240.000 207.000 m 232.000 205.000 l 240.000 203.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 581 273 m 581 273 l  431 273 l  431 273 l 
 clp gs col-1 s gr
% Polyline
n 568 260 m 568 224 l  499 224 l  499 260 l 
 clp gs col-1 s gr
% Polyline
n 490 269 m 490 260 l  436 260 l  436 269 l 
 clp gs col-1 s gr
% Polyline
n 490 255 m 490 246 l  436 246 l  436 255 l 
 clp gs col-1 s gr
% Polyline
n 490 242 m 490 233 l  436 233 l  436 242 l 
 clp gs col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 568 224 m 622 183 l gs col-1 s gr
	[] 0 setdash
	[4.000000] 0 setdash
% Polyline
n 499 224 m 622 110 l gs col-1 s gr
	[] 0 setdash
	[4.000000] 0 setdash
% Polyline
n 499 260 m 622 301 l gs col-1 s gr
	[] 0 setdash
	[4.000000] 0 setdash
% Polyline
n 568 260 m 622 273 l gs col-1 s gr
	[] 0 setdash
% Polyline
n 581 273 m 581 215 l  431 215 l  431 273 l 
 clp gs col-1 s gr
% Polyline
n 622 301 m 622 110 l  722 110 l  722 301 l 
 clp gs col-1 s gr
% Polyline
n 722 174 m 722 110 l  622 110 l  622 174 l 
 clp gs col-1 s gr
% Polyline
n 722 237 m 722 174 l  622 174 l  622 237 l 
 clp gs col-1 s gr
% Polyline
n 722 301 m 722 237 l  622 237 l  622 301 l 
 clp gs col-1 s gr
/Times-Roman findfont 11.00 scalefont setfont
78 97 m 
gs 1 -1 scale (Machine Simulator:) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
96 500 m 
gs 1 -1 scale (Main Memory: 128pages, 128 bytes per page.) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
96 518 m 
gs 1 -1 scale (Page 0) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
96 532 m 
gs 1 -1 scale (owners) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
96 545 m 
gs 1 -1 scale (owners #) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
214 532 m 
gs 1 -1 scale (owners) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
214 545 m 
gs 1 -1 scale (owners #) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
450 532 m 
gs 1 -1 scale (owners) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
450 545 m 
gs 1 -1 scale (owners #) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
568 532 m 
gs 1 -1 scale (owners) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
568 545 m 
gs 1 -1 scale (owners #) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
214 518 m 
gs 1 -1 scale (Page 1) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
450 518 m 
gs 1 -1 scale (Page 126) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
568 518 m 
gs 1 -1 scale (Page 127) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
105 183 m 
gs 1 -1 scale (next_inst = read_mem\(pc\);) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
105 199 m 
gs 1 -1 scale (execute_inst\( next_inst \);) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
105 215 m 
gs 1 -1 scale (pc++;) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
282 137 m 
gs 1 -1 scale (read_mem\(\)) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
282 165 m 
gs 1 -1 scale (translate_address\(pc\)) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
454 115 m 
gs 1 -1 scale (Logical Address) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
445 183 m 
gs 1 -1 scale (Physical Address) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
282 187 m 
gs 1 -1 scale (read_main_memory\(\)) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
504 246 m 
gs 1 -1 scale (Page Table) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
636 106 m 
gs 1 -1 scale (Page Table) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 128 m 
gs 1 -1 scale (virtualPage = 0) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 142 m 
gs 1 -1 scale (physicalpage = 1) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 169 m 
gs 1 -1 scale (readonly = FALSE) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 156 m 
gs 1 -1 scale (dirty = FALSE) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 192 m 
gs 1 -1 scale (virtualPage = 1) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 205 m 
gs 1 -1 scale (physicalPage = 6) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 219 m 
gs 1 -1 scale (dirty = FALSE) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 233 m 
gs 1 -1 scale (readonly = FALSE) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 255 m 
gs 1 -1 scale (virtualPage = 2) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 269 m 
gs 1 -1 scale (physicalPage = 4) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 283 m 
gs 1 -1 scale (dirty = FALSE) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
631 296 m 
gs 1 -1 scale (readonly = FALSE) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
78 124 m 
gs 1 -1 scale (Fetch-Execute w/ no PageFault) col-1 show gr
/Times-Roman findfont 9.00 scalefont setfont
439 229 m 
gs 1 -1 scale (Registers) col-1 show gr
/Times-Roman findfont 11.00 scalefont setfont
298 353 m 
gs 1 -1 scale (Next Instruction) col-1 show gr
$F2psEnd

%%EndDocument
 @endspecial 1405 2863 a Fe(Figure)24 b(3:)29 b(Address)24
b(T)m(ranslation)0 3140 y Fa(2.3)99 b(Machine\(bool)26
b(deb)n(ug\))0 3315 y Fe(The)19 b(Machine)i(constructor)i(tak)o(es)d(a)
f(single)i(ar)n(gument)h(deb)n(ug.)29 b(When)20 b(deb)n(ug)h(is)e(TR)l
(UE,)e(the)j(MIPS)e(simulator)j Fc(\(de\002ned)0 3428
y(in)28 b(mipssim.cc\))i Fe(e)o(x)o(ecutes)g(instructions)i(in)c
(single)i(step)g(mode,)f(in)l(v)n(oking)j Fc(BREAKPOINT\(r)m(e)l
(gister)o(s[PCRe)l(g]\))c Fe(after)0 3540 y(each)e(instruction)i(is)d
(e)o(x)o(ecuted.)35 b(That)24 b(instruction)29 b(inturn)d(re)o(gresses)
h(the)e(PC)f(re)o(gisters)j(so)e(that)g(we)g(re-e)o(x)o(ecute)i(the)e
(in-)0 3653 y(struction)i(that)f(had)f(been)h(replaced)h(by)e(the)g
(breakpoint)j(instruction.)36 b(The)24 b(instruction)k
(BREAKPOINT\(addr\))23 b(raises)0 3766 y(an)29 b(e)o(xception)i
(\(Breakpoint)g(Exception\))g(with)e(the)g(address)i(as)e(an)g(ar)n
(gument)i(as)e(de\002ned)g(in)g(machine.h)h(as)f Fc(\(#de\002ne)0
3879 y(BREAKPOINT\(addr\))e(mac)o(hine)i(->RaiseException\(Br)m
(eakpoin)q(tExce)q(pt)q(ion)q(,)35 b(addr\))p Fe(.)45
b(This)29 b(allo)n(ws)g(one)g(to)f(interac-)0 3992 y(ti)n(v)o(ely)f(e)o
(xamine)g(machine)h(state)f(to)f(v)o(erify)i(\(for)e(instance\))j(that)
e(re)o(gisters)h(or)e(memory)h(contain)h(e)o(xpected)h(v)n(alues.)38
b(By)0 4105 y(def)o(ault,)26 b(single-stepping)j(is)24
b(disabled.)34 b(It)24 b(is)g(enabled)i(by)f(specifying)i(the)e
(\223-s\224)g(command)g(line)g(option)h(when)e(starting)0
4218 y(Nachos)g(up.)0 4467 y Fa(2.4)99 b(ExceptionT)-7
b(ype)27 b(T)-7 b(ranslate\(int)25 b(virtAddr)-9 b(,)26
b(int*)f(ph)o(ysAddr)-9 b(,)25 b(int)g(size,)g(bool)g(writing\))0
4641 y Fe(This)k(con)l(v)o(erts)i(virtual)g(address)g
Fc(virtAddr)f Fe(into)g(its)f(corresponding)k(physical)e(address)g
Fc(physAddr)p Fe(.)47 b Fc(T)-5 b(r)o(anslate)30 b Fe(e)o(xam-)0
4754 y(ines)e(the)g(machine')-5 b(s)29 b(translation)i(tables)e
(\(described)h(in)d(detail)i(in)f(Section)g(9.\))41 b(in)27
b(order)i(to)e(perform)i(the)e(translation.)0 4867 y(When)d
(successful,)i Fc(T)-5 b(r)o(anslate)25 b Fe(returns)h(the)e
(corresponding)k(physical)d(address)h(in)e Fc(physAddr)p
Fe(.)30 b(Otherwise,)25 b(it)e(returns)j(a)0 4980 y(code)f(indicating)h
(the)e(reason)i(for)e(the)g(f)o(ailure)h(\(e.g.,)e(page)i(f)o(ault,)f
(protection)j(violation,)f(etc.\))k(Whene)n(v)o(er)25
b(a)e(translation)0 5093 y(f)o(ails,)32 b(the)e(MIPS)e(simulator)j(in)l
(v)n(ok)o(es)h(the)e(Nachos)h(routine)g Fc(RaiseException)h
Fe(to)e(deal)g(with)g(the)g(problem.)48 b Fc(RaiseEx-)0
5206 y(ception)27 b Fe(is)d(responsible)k(for)d(handling)j(all)d(hardw)
o(are)h(trap)f(conditions.)36 b(When)25 b Fc(RaiseException)j
Fe(returns,)e(the)f(Nachos)0 5319 y(Machine)g(assumes)g(that)g(the)f
(condition)i(has)f(been)f(corrected)i(and)f(resumes)g(its)f(fetch-e)o
(x)o(ecute)j(c)o(ycle.)j(Note)24 b(that)g(from)1927 5649
y(4)p eop end
%%Page: 5 5
TeXDict begin 5 4 bop 0 91 a Fe(a)28 b(user)n(-le)n(v)o(el)i(process')
-5 b(s)31 b(perspecti)n(v)o(e,)g(traps)e(tak)o(e)g(place)g(in)f(the)h
(same)f(w)o(ay)g(as)g(if)g(the)g(program)h(were)f(e)o(x)o(ecuting)i(on)
f(a)0 204 y(bare)f(machine;)k(a)27 b(trap)h(handler)i(is)e(in)l(v)n(ok)
o(ed)i(to)e(deal)g(with)g(the)g(problem.)42 b(Ho)n(we)n(v)o(er)l(,)29
b(from)e(the)h(Nachos)h(perspecti)n(v)o(e,)0 317 y Fc(RaiseException)d
Fe(is)e(called)g(via)g(a)f(normal)i(procedure)h(call)e(by)f(the)h(MIPS)
e(simulator)-5 b(.)0 566 y Fa(2.5)99 b(OneInstruction\(\))0
741 y Fe(This)20 b(function)i(does)e(the)g(actual)h(w)o(ork)f(of)g(e)o
(x)o(ecuting)h(an)f(instruction.)31 b(It)19 b(fetches)i(the)f(current)i
(instruction)h(address)e(from)0 854 y(the)h(PC)e(re)o(gister)l(,)k
(fetches)g(it)d(from)h(memory)-6 b(,)22 b(decodes)i(it,)e(and)g
(\002nally)g(e)o(x)o(ecutes)i(it.)k(An)o(y)21 b(addresses)j(referenced)
h(as)d(part)0 966 y(of)30 b(the)g(fetch/e)o(x)o(ecute)k(c)o(ycle)c
(\(including)j(the)e(instruction)i(address)f(gi)n(v)o(en)f(by)f(PCRe)o
(g\))f(are)h(translated)j(into)d(physical)0 1079 y(addresses)c(via)e
(the)g Fc(T)-5 b(r)o(anslate\(\))25 b Fe(routine)g(before)g(physical)h
(memory)d(is)h(actually)h(accessed.)0 1329 y Fa(2.6)99
b(Run\(\))0 1503 y Fe(It)25 b(\223turns)i(on\224)f(the)g(MIPS)e
(machine,)j(initiating)h(the)d(fetch-e)o(x)o(ecute)k(c)o(ycle.)35
b(This)26 b(routine)h(should)g(only)f(be)g(called)g(after)0
1616 y(machine)c(re)o(gisters)g(and)f(memory)f(ha)n(v)o(e)h(been)h
(properly)g(initialized.)31 b(It)20 b(simply)h(enters)h(an)e
(in\002nite)h(fetch-e)o(x)o(ecute)j(loop.)0 1729 y(The)f(main)h(loop)h
(in)f Fc(Run)f Fe(does)i(three)f(things:)32 b(1\))23
b(it)h(in)l(v)n(ok)o(es)i Fc(OneInstruction)i Fe(to)c(actually)h(e)o(x)
o(ecute)g(one)g(instruction,)h(2\))0 1842 y(it)h(in)l(v)n(ok)o(es)j
(the)e(BreakPoint)g(Exception,)i(if)d(the)h(user)g(has)g(requested)i
(single-step)g(mode)e(on)f(the)h(command)g(line,)h(and)0
1954 y(3\))c(it)f(increments)j(a)e(simulated)h(clock)g(after)g(each)g
(instruction.)36 b(The)24 b(clock,)i(which)f(is)g(used)h(to)f(simulate)
h(interrupts,)h(is)0 2067 y(discussed)f(in)e(the)f(follo)n(wing)i
(section.)141 2180 y Fc(Mac)o(hine::Run\(\))30 b Fe(gets)d(the)h(ne)o
(xt)f(instruction)k(\(from)c(the)g(position)j(indicated)f(by)e(the)h
(program)g(counter\))h(and)f(de-)0 2293 y(codes)i(it.)44
b(It)29 b(then)g(uses)h(a)e(switch)h(statement)i(containing)h(one)d
(case)g(for)g(each)h(of)e(the)h(instructions)k(in)28
b(the)h(machine')-5 b(s)0 2406 y(instruction)27 b(set,)c(in)h(order)g
(to)g(e)n(v)n(aluate)h(the)e(instruction.)32 b(P)o(art)23
b(of)h(this)g(switch)g(statement)h(is)e(sho)n(wn)h(belo)n(w:)218
2732 y Fb(switch\(instr->o)o(pC)o(ode)o(\))48 b({)436
2844 y(...)436 2957 y(...)436 3070 y(...)327 3183 y(case)53
b(OP\\_SYSCALL:)436 3296 y(RaiseException\(S)o(ys)o(ca)o(ll)o(Ex)o(cep)
o(ti)o(on)o(,)48 b(0\);)436 3409 y(break;)327 3635 y(case)53
b(OP\\_XOR:)436 3748 y(registers[instr-)o(>r)o(d])48
b(=)54 b(registers[instr)o(->)o(rs)o(])48 b(^)54 b(...)436
3861 y(break;)327 4086 y(case)f(OP\\_XORI:)436 4199 y(registers[instr-)
o(>r)o(t])48 b(=)54 b(registers[instr)o(->)o(rs)o(])48
b(^)54 b(...)436 4312 y(break;)327 4538 y(case)f(OP\\_UNIMP:)436
4651 y(RaiseException\(I)o(ll)o(eg)o(al)o(In)o(str)o(Ex)o(ce)o(pt)o(io)
o(n,)48 b(0\);)436 4764 y(return;)436 4877 y(...)436
4990 y(...)436 5103 y(...)218 5216 y(})1927 5649 y Fe(5)p
eop end
%%Page: 6 6
TeXDict begin 6 5 bop 141 91 a Fe(Note)24 b(that)g(in)f(the)h(case)g
(of)f(an)h(OP_SYSCALL)19 b(the)24 b(machine)g(calls)h
Fc(RaiseException)p Fe(,)h(which)d(is)h(the)f(equi)n(v)n(alent)j(of)0
204 y(a)g(trap)h(into)g(k)o(ernel)h(space)g(in)f(a)f(normal)h
(operating)i(system.)39 b(The)26 b(path)h(of)f(a)h(system)g(call)g
(trap)g(into)g(k)o(ernel)h(space)g(can)0 317 y(be)c(seen)g(belo)n(w:)
1927 5649 y(6)p eop end
%%Page: 7 7
TeXDict begin 7 6 bop 0 3054 a @beginspecial 0 @llx 0
@lly 724 @urx 567 @ury 4680 @rwi @setspecial
%%BeginDocument: figures/nachos5.eps
%!PS-Adobe-2.0 EPSF
%%Title: /tmp/xfig-fig000712
%%Creator: fig2dev
%%CreationDate: Wed Oct 30 20:47:18 1996
%%For: rhill@dante (Robert Hill)
%%BoundingBox: 0 0 724 567
%%Pages: 0
%%EndComments
/$F2psDict 200 dict def 
$F2psDict begin
$F2psDict /mtrx matrix put
/l {lineto} bind def
/m {moveto} bind def
/s {stroke} bind def
/n {newpath} bind def
/gs {gsave} bind def
/gr {grestore} bind def
/clp {closepath} bind def
/graycol {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
4 -2 roll mul setrgbcolor} bind def
/col-1 {} def
/col0 {0 0 0 setrgbcolor} bind def
/col1 {0 0 1 setrgbcolor} bind def
/col2 {0 1 0 setrgbcolor} bind def
/col3 {0 1 1 setrgbcolor} bind def
/col4 {1 0 0 setrgbcolor} bind def
/col5 {1 0 1 setrgbcolor} bind def
/col6 {1 1 0 setrgbcolor} bind def
/col7 {1 1 1 setrgbcolor} bind def
	end
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def
%%EndProlog

$F2psBegin
0 setlinecap 0 setlinejoin
-45.0 571.0 translate 0.900 -0.900 scale
0.500 setlinewidth
% Polyline
n 479 269 m 479 539 l  494 519 l  509 539 l 
 524 519 l  534 539 l  544 519 l  559 534 l  569 514 l 
 584 539 l  589 519 l gs col-1 s gr
n 589 519 m 609 534 l  614 519 l  629 534 l 
 644 514 l  654 534 l  669 514 l  684 534 l  689 509 l 
 694 524 l  694 269 l gs col-1 s gr
n 694 269 m 479 269 l gs col-1 s gr
/Times-Roman findfont 12.00 scalefont setfont
484 289 m 
gs 1 -1 scale (do_system_call\(int syscall_num\) {) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 307 m 
gs 1 -1 scale (reg4 = machine->ReadRegister\(4\);) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 325 m 
gs 1 -1 scale (reg5 = machine->ReadRegister\(5\);) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 343 m 
gs 1 -1 scale (reg6 = machine->ReadRegister\(6\);) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 361 m 
gs 1 -1 scale (reg7 = machine->ReadRegister\(7\);) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 397 m 
gs 1 -1 scale (switch \(syscall_num\) {) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 415 m 
gs 1 -1 scale (case SC_HALT :) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 433 m 
gs 1 -1 scale (      System_Halt\(\);) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 451 m 
gs 1 -1 scale (      break;) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 469 m 
gs 1 -1 scale (case SC_Exec:) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 487 m 
gs 1 -1 scale (       returnvalue = System_Exec\( reg4 \);) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 505 m 
gs 1 -1 scale (       break;) col-1 show gr
n 597.950 43.396 m 604.000 49.000 l 596.025 46.903 l gs 2 setlinejoin col-1 s gr
	1 setlinecap [1 3.000000] 3.000000 setdash
n 544.953 156.536 122.680 -134.477 -61.229 arc
gs col-1 s gr
	[] 0 setdash 0 setlinecap
% Polyline
n 49 74 m 49 299 l  59 269 l  69 289 l 
 74 274 l  84 289 l  94 274 l  109 289 l  119 279 l 
 134 294 l  149 284 l gs col-1 s gr
n 149 284 m 164 294 l  179 279 l  184 294 l 
 194 279 l  209 294 l  224 279 l  244 299 l  249 279 l 
 264 294 l  269 284 l gs col-1 s gr
n 269 284 m 269 59 l  49 59 l  49 79 l gs col-1 s gr
% Polyline
n 49 539 m 49 314 l  59 344 l  69 324 l 
 74 339 l  84 324 l  94 339 l  109 324 l  119 334 l 
 134 319 l  149 329 l gs col-1 s gr
n 149 329 m 164 319 l  179 334 l  184 319 l 
 194 334 l  209 319 l  224 334 l  244 314 l  249 334 l 
 264 319 l  269 329 l gs col-1 s gr
n 269 329 m 269 554 l  49 554 l  49 534 l gs col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 264 379 m 289 379 l  289 84 l  304 84 l gs col-1 s gr
	[] 0 setdash
n 296.000 82.000 m 304.000 84.000 l 296.000 86.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 554 189 m 554 74 l  309 74 l  309 189 l 
 clp gs col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 454 129 m 579 129 l gs col-1 s gr
	[] 0 setdash
n 571.000 127.000 m 579.000 129.000 l 571.000 131.000 l gs 2 setlinejoin col-1 s gr
1.000 setlinewidth
	1 setlinecap [1 4.500000] 4.500000 setdash
% Polyline
n 564 4 m 564 224 l  354 224 l  354 629 l gs col-1 s gr
	[] 0 setdash 0 setlinecap
0.500 setlinewidth
	1 setlinecap [1 3.000000] 3.000000 setdash
% Polyline
n 819 194 m 819 69 l  589 69 l  589 194 l 
 clp gs col-1 s gr
	[] 0 setdash 0 setlinecap
% Polyline
n 819 194 m 819 69 l  589 69 l  589 194 l 
 clp gs col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 764 154 m 854 154 l  854 279 l  709 279 l gs col-1 s gr
	[] 0 setdash
n 717.000 281.000 m 709.000 279.000 l 717.000 277.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 479 544 m 479 634 l  699 634 l  699 529 l 
 684 549 l  669 539 l  659 549 l  649 544 l  639 549 l 
 629 534 l  619 554 l gs col-1 s gr
n 619 554 m 614 544 l  604 559 l  604 544 l 
 584 559 l  574 544 l  559 554 l  549 534 l  534 559 l 
 529 544 l  514 559 l gs col-1 s gr
n 514 559 m 499 539 l  494 549 l  479 544 l gs col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 484 574 m 279 404 l gs col-1 s gr
	[] 0 setdash
n 283.881 410.646 m 279.000 404.000 l 286.435 407.567 l gs 2 setlinejoin col-1 s gr
/Times-Roman findfont 12.00 scalefont setfont
59 94 m 
gs 1 -1 scale (Machine::OneInstruction\(Inst\)) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
59 112 m 
gs 1 -1 scale ({) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
59 130 m 
gs 1 -1 scale (switch \(Inst\) {) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
59 166 m 
gs 1 -1 scale (     case OP_ADD:) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
59 184 m 
gs 1 -1 scale (          sum = registers[instr->rs] + ...) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
59 202 m 
gs 1 -1 scale (          return;) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
59 220 m 
gs 1 -1 scale (     case OP_ADDI:) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
59 238 m 
gs 1 -1 scale (          sum = registers[instr->rs] + ...) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
59 256 m 
gs 1 -1 scale (          return;) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
64 49 m 
gs 1 -1 scale (mipssim.cc) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
64 364 m 
gs 1 -1 scale (case OP_SYSCALL:) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
64 382 m 
gs 1 -1 scale (      RaiseExeption\(SyscallException\);) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
64 400 m 
gs 1 -1 scale (      return;) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
64 418 m 
gs 1 -1 scale (case OP_XOR:) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
64 436 m 
gs 1 -1 scale (      registers[instr->rd] = registers[...) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
64 454 m 
gs 1 -1 scale (      return;) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
69 474 m 
gs 1 -1 scale (default:) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
69 492 m 
gs 1 -1 scale (     ASSERT\(FALSE\);) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
69 510 m 
gs 1 -1 scale (}) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
319 99 m 
gs 1 -1 scale (Machine::RaiseExeption\(Exception Type\)) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
319 117 m 
gs 1 -1 scale ({) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
319 135 m 
gs 1 -1 scale ( ExceptionHandler\(which\)) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
319 159 m 
gs 1 -1 scale (}) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
604 89 m 
gs 1 -1 scale (ExeptionHandler\(ExceptionType which\)) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
604 107 m 
gs 1 -1 scale ({) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
604 125 m 
gs 1 -1 scale (  int type = machine->ReadRegister\(2\);) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
604 143 m 
gs 1 -1 scale (  if \( which == SyscallException \) {) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
604 161 m 
gs 1 -1 scale (      do_system_call\(type\);) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
604 179 m 
gs 1 -1 scale (} ) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
364 244 m 
gs 1 -1 scale (Kernel Mode) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
354 214 m 
gs 1 -1 scale (User Mode) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
499 29 m 
gs 1 -1 scale (Trap to Kernel Mode) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
489 579 m 
gs 1 -1 scale (machine->WriteRegister\(2, returnvalue\)) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
489 604 m 
gs 1 -1 scale (}) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
484 264 m 
gs 1 -1 scale (systemcall.cc) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
609 64 m 
gs 1 -1 scale (exception.cc) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
324 69 m 
gs 1 -1 scale (mipssim.cc) col-1 show gr
$F2psEnd

%%EndDocument
 @endspecial 1353 3250 a Fe(Figure)24 b(4:)29 b(T)m(rap)23
b(into)h(K)n(ernel)g(Mode)0 3618 y Fa(2.7)99 b(int)25
b(ReadRegister\(int)h(num\))0 3792 y Fe(fetches)f(the)f(v)n(alue)g
(stored)h(in)f(re)o(gister)h(num.)0 4041 y Fa(2.8)99
b(v)o(oid)25 b(WriteRegister\(int)g(num,)h(int)f(v)o(alue\))0
4216 y Fe(places)g(v)n(alue)f(into)g(re)o(gister)h(num.)0
4465 y Fa(2.9)99 b(bool)25 b(ReadMem\(int)h(addr)-9 b(,)25
b(int)g(size,)g(int*)g(v)o(alue\))0 4639 y Fe(Retrie)n(v)o(es)32
b(1,)h(2,)f(or)g(4)e(bytes)j(of)e(memory)g(at)h(virtual)g(address)h
(addr)-5 b(.)53 b(Note)31 b(that)h(addr)g(is)f(the)h(virtual)h(address)
g(of)e(the)0 4752 y(currently)i(e)o(x)o(ecuting)g(user)n(-le)n(v)o(el)g
(program;)j Fc(ReadMem)31 b Fe(in)l(v)n(ok)o(es)i Fc(T)-5
b(r)o(anslate)33 b Fe(before)f(it)f(accesses)i(physical)f(memory)-6
b(.)0 4865 y(One)22 b(point)i(that)f(should)i(be)d(noted)i(is)e(that)i
Fc(ReadMem)e Fe(f)o(ails)i(\(returning)h(F)-7 b(ALSE\),)20
b(if)i(the)h(address)i(translation)g(f)o(ails)f(\(for)0
4978 y(whate)n(v)o(er)j(reason\).)39 b(Thus,)27 b(if)f(the)g(page)i(is)
e(not)h(present)h(in)e(physical)i(memory)-6 b(,)27 b
Fc(ReadMem)f Fe(f)o(ails.)38 b Fc(ReadMem)p Fe(does)28
b(not)0 5091 y(distinguish)f(temporary)e(f)o(ailures\(e)o(g.,)h(P)o
(age)d(not)h(in)f(memory\)from)i(hard)f(errors)h(\(e.g.,)e(in)l(v)n
(alid)i(virtual)g(address\).)1927 5649 y(7)p eop end
%%Page: 8 8
TeXDict begin 8 7 bop 0 91 a Fa(2.10)99 b(bool)25 b(WriteMem\(int)g
(addr)-9 b(,)26 b(int)f(size,)g(int)g(v)o(alue\))0 266
y Fe(writes)e(1,)g(2,)f(or)h(4)f(bytes)i(of)f(v)n(alue)h(into)f(memory)
g(at)g(virtual)h(address)h(addr)-5 b(.)29 b(The)23 b(same)g(w)o
(arnings)h(gi)n(v)o(en)f(for)g Fc(ReadMem)0 379 y Fe(apply)i(here)f(as)
f(well.)0 670 y Ff(3)119 b(Interrupt)31 b(Management)0
877 y Fe(Nachos)e(simulates)i(interrupts)g(by)d(maintaining)k(an)c(e)n
(v)o(ent)h(queue)h(together)h(with)d(a)g(simulated)j(clock.)44
b(As)28 b(the)h(clock)0 989 y(ticks,)36 b(the)e(e)n(v)o(ent)g(queue)g
(is)f(e)o(xamined)i(to)e(\002nd)g(e)n(v)o(ents)h(scheduled)i(to)e(tak)o
(e)g(place)g(no)n(w)-6 b(.)58 b(The)32 b(clock)j(is)e(maintained)0
1102 y(entirely)25 b(in)f(softw)o(are)h(and)f(ticks)g(under)h(the)f
(follo)n(wing)h(conditions:)114 1305 y(1.)45 b(Ev)o(ery)27
b(time)f(interrupts)j(are)e(restored)h(\(and)f(the)g(restored)h
(interrupt)h(mask)d(has)h(interrupts)i(enabled\),)g(the)e(clock)227
1418 y(adv)n(ances)g(one)f(tick.)34 b(Nachos)25 b(code)h(frequently)i
(disables)f(and)f(restores)h(interrupts)g(for)e(mutual)h(e)o(xclusion)h
(pur)n(-)227 1531 y(poses)e(by)f(making)g(e)o(xplicit)h(calls)g(to)e
Fc(interrupt::SetLe)o(vel\(\))p Fe(.)114 1715 y(2.)45
b(Whene)n(v)o(er)25 b(the)f(MIPS)e(simulator)j(e)o(x)o(ecutes)g(one)f
(instruction,)i(the)e(clock)h(adv)n(ances)g(one)f(tick.)114
1899 y(3.)45 b(Whene)n(v)o(er)27 b(the)e(ready)i(list)f(is)f(empty)-6
b(,)26 b(the)g(clock)g(adv)n(ances)i(ho)n(we)n(v)o(er)d(man)o(y)g
(ticks)i(are)e(needed)i(to)f(f)o(ast-forw)o(ard)227 2012
y(the)e(current)h(time)f(to)f(that)h(of)g(the)f(ne)o(xt)h(scheduled)j
(e)n(v)o(ent.)0 2215 y(Whene)n(v)o(er)j(the)f(clock)i(adv)n(ances,)h
(the)d(e)n(v)o(ent)h(queue)g(is)f(e)o(xamined)h(and)f(an)o(y)h(pending)
h(interrupt)g(e)n(v)o(ents)f(are)f(serviced)0 2328 y(by)d(in)l(v)n
(oking)i(the)e(procedure)i(associated)g(with)d(the)h(timer)g(e)n(v)o
(ent)g(\(e.g.,)f(the)h(interrupt)i(service)f(routine\).)36
b(All)25 b(interrupt)0 2441 y(service)g(routines)h(are)e(run)f(with)h
(interrupts)i(disabled,)f(and)f(the)g(interrupt)i(service)f(routine)h
(may)d(not)h(re-enable)i(them.)141 2554 y(W)-7 b(arning:)48
b(An)32 b(interrupt)j(handler)f(may)e(not)h(call)g(an)o(y)f(routines)j
(that)e(lead)g(to)g(a)f(conte)o(xt)h(switch)g(of)g(the)g(current)0
2667 y(thread)25 b(\(e.g.,)d(scheduler::Run\(\))28 b(or)23
b(SWITCH\(\))e(\).)28 b(Doing)c(so)f(may)g(lead)g(to)g(deadlock.)31
b(This)23 b(restriction)j(is)d(an)g(artif)o(act)0 2780
y(of)e(the)h(w)o(ay)f(interrupts)j(are)e(simulated)h(under)f(Nachos,)g
(and)g(should)h(not)f(be)f(tak)o(en)i(as)e(an)h(indication)i(of)d(the)h
(w)o(ay)f(things)0 2892 y(are)30 b(done)h(on)g(real)f(machines.)51
b(Speci\002cally)-6 b(,)33 b(consider)f(the)f(case)f(where)h(multiple)g
(e)n(v)o(ents)g(happen)h(to)e(be)g(scheduled)0 3005 y(at)d(e)o(xactly)h
(the)f(same)f(time.)38 b(If)27 b(the)g(handler)h(for)f(the)g(\002rst)f
(e)n(v)o(ent)i(in)l(v)n(ok)o(es)h(sleep)f(\(which)f(calls)h(SWITCH\),)c
(the)j(others)0 3118 y(w)o(on')n(t)h(be)f(serviced)i(at)e(the)h(right)g
(time.)40 b(In)27 b(f)o(act,)h(the)g(thread)g(that)g(called)g(sleep)h
(may)e(actually)i(be)e(w)o(aiting)h(for)g(one)f(of)0
3231 y(the)e(other)g(e)n(v)o(ents)g(that)g(is)f(supposed)i(to)f(tak)o
(e)f(place)i(no)n(w)-6 b(,)23 b(b)n(ut)i(is)f(delayed)i(because)h(of)d
(the)g(SWITCH.)e(W)-7 b(e)23 b(no)n(w)h(ha)n(v)o(e)h(a)0
3344 y(deadlock.)141 3457 y(All)f(routines)j(related)f(to)e(interrupt)j
(management)g(are)d(pro)o(vided)j(by)e(the)g(Interrupt)i(object.)33
b(The)24 b(main)h(routines)h(of)0 3570 y(interest)f(include:)0
3818 y Fa(3.1)99 b(v)o(oid)25 b(Schedule\(V)-10 b(oidFunctionPtr)28
b(handler)-9 b(,)26 b(int)f(ar)o(g,)g(int)g(when,)h(IntT)-7
b(ype)25 b(type\))0 3992 y Fe(schedules)30 b(a)c(future)i(e)n(v)o(ent)g
(to)f(tak)o(e)h(place)g(at)e(time)h(when.)39 b(When)28
b(it)e(is)h(time)g(for)g(the)h(scheduled)h(e)n(v)o(ent)f(to)f(tak)o(e)g
(place,)0 4105 y(Nachos)d(calls)h(the)f(routine)h(handler)g(with)f(the)
f(single)i(ar)n(gument)h(ar)n(g.)0 4352 y Fa(3.2)99 b(IntStatus)26
b(SetLe)o(v)o(el\(IntStatus)h(le)o(v)o(el\))0 4527 y
Fe(Change)d(the)g(interrupt)i(mask)d(to)h(le)n(v)o(el,)f(returning)j
(the)e(pre)n(vious)i(v)n(alue.)j(This)23 b(routine)j(is)d(used)h(to)g
(temporarily)h(disable)0 4639 y(and)g(re-enable)j(interrupts)f(for)f
(mutual)f(e)o(xclusion)j(purposes.)35 b(Only)25 b(tw)o(o)g(interrupt)i
(le)n(v)o(els)e(are)h(supported:)34 b(IntOn)26 b(and)0
4752 y(IntOf)n(f.)0 5000 y Fa(3.3)99 b(OneT)n(ick\(\))0
5174 y Fe(adv)n(ances)31 b(the)f(clock)g(one)g(tick)g(and)g(services)h
(an)o(y)e(pending)j(requests)f(\(by)f(calling)h(CheckIfDue\).)48
b(It)29 b(is)g(called)h(from)0 5287 y(machine::Run\(\))e(after)e(each)g
(user)n(-le)n(v)o(el)h(instruction)h(is)d(e)o(x)o(ecuted,)i(as)e(well)g
(as)g(by)g(SetLe)n(v)o(el)g(when)g(the)g(interrupts)j(are)0
5400 y(restored.)1927 5649 y(8)p eop end
%%Page: 9 9
TeXDict begin 9 8 bop 0 91 a Fa(3.4)99 b(bool)25 b(CheckIfDue\(bool)h
(adv)o(anceClock\))0 266 y Fe(e)o(xamines)h(the)g(e)n(v)o(ent)f(queue)i
(for)e(e)n(v)o(ents)h(that)g(need)g(servicing)i(no)n(w)-6
b(.)36 b(If)26 b(it)g(\002nds)g(an)o(y)-6 b(,)27 b(it)f(services)i
(them.)37 b(It)25 b(is)h(in)l(v)n(ok)o(ed)0 379 y(in)d(OneT)m(ick)h
(and)g(Idle.)0 628 y Fa(3.5)99 b(Idle\(\))0 802 y Fe(\223adv)n
(ances\224)27 b(the)d(clock)h(to)f(the)g(time)f(of)h(the)g(ne)o(xt)g
(scheduled)j(e)n(v)o(ent.)j(It)24 b(is)f(called)j(by)e(the)g(scheduler)
i(\(actually)g(Sleep\(\)\))0 915 y(when)e(there)g(are)g(no)f(more)h
(threads)h(on)f(the)g(ready)g(list)g(and)g(we)f(w)o(ant)h(to)f(\223f)o
(ast-forw)o(ard\224)k(the)d(time.)0 1207 y Ff(4)119 b(Real-T)n(ime)30
b(Clock)h(Interrupts)0 1414 y Fe(Nachos)e(pro)o(vides)h(a)d(T)m(imer)g
(object)j(that)e(simulates)i(a)e(real)g(time)g(clock,)i(generating)h
(interrupts)f(at)e(re)o(gular)h(interv)n(als.)0 1527
y(It)i(is)f(implemented)j(using)f(the)f(same)g(e)n(v)o(ent)h(dri)n(v)o
(en)f(interrupt)j(mechanism)e(described)h(abo)o(v)o(e.)52
b(T)m(imer)30 b(supports)j(the)0 1640 y(follo)n(wing)25
b(operation:)0 1890 y Fa(4.1)99 b(T)n(imer\(V)-10 b(oidFunctionPtr)27
b(timerHandler)-9 b(,)25 b(int)h(callAr)o(g,)e(bool)g(doRandom\))0
2064 y Fe(The)i(T)m(imer)f(constructor)k(creates)f(a)d(real-time)j
(clock)f(that)f(interrupts)j(e)n(v)o(ery)e(T)m(imerT)m(icks)f(\(100\))h
(time)f(units)h(speci\002ed)0 2177 y(in)22 b Fc(mac)o(hine/stats.h)p
Fe(.)31 b(When)22 b(the)h(timer)f(goes)h(of)n(f,)f(the)g(Nachos)h
(simulator)h(in)l(v)n(ok)o(es)g(procedure)h(timerHandler)l(,)f(passing)
0 2290 y(it)c(callAr)n(g)i(as)f(an)g(ar)n(gument.)30
b(T)-7 b(o)19 b(add)i(a)g(bit)g(of)f(non-determinism)25
b(to)20 b(the)h(system,)h(ar)n(gument)h(doRandom)f(speci\002es)g(that)0
2403 y(the)g(time)f(between)h(interrupts)i(should)f(be)e(tak)o(en)i
(from)e(a)g(uniform)h(interv)n(al)h(between)g(1)e(and)h(RAND_MAX)c(as)j
(de\002ned)0 2515 y(in)i(the)h(rand\(\))h(function)g(which)f(is)f(in)l
(v)n(ok)o(ed)j(from)e(the)f(machine/sysdep.cc,)28 b(which)c(in)f(turn)h
(,)e(includes)k(the)e(standard)h(C)0 2628 y(library)g(header)g
(\002les.)141 2741 y(The)e(real-time)i(clock)g(can)f(be)f(used)i(to)e
(pro)o(vide)i(preemption.)141 2854 y(Note)f(that)h(starting)h(Nachos)f
(with)f(the)g(\223-rs\224)h(option)h(creates)f(a)f(timer)g(object)i
(that)e(interrupts)j(at)d(random)h(interv)n(als)0 2967
y(and)f(preempts)h(the)f(currently)i(running)f(thread.)0
3260 y Ff(5)119 b(The)31 b(Nachos)e(Thr)n(ead)0 3467
y Fe(A)e(Nachos)h(thread)h(can)f(be)g(vie)n(wed)g(as)g(a)f(diminuti)n
(v)o(e)i(process.)43 b(Threads)29 b(are)e(created)j(and)e(destro)o(yed)
i(with)e(the)g Fc(F)-10 b(ork)0 3580 y Fe(and)33 b Fc(Exit)g
Fe(system)g(calls,)j(respecti)n(v)o(ely)-6 b(.)60 b(The)32
b(thread)j(object)f(also)f(contains)i(a)e(set)g(of)g(structures)i
(similar)f(to)f(a)f(Unix)0 3692 y(processes)26 b(PCB.)21
b(The)i(thread)i(object)g(is)f(pictured)h(belo)n(w:)0
3905 y Fb(From:)52 b(code/threads/th)o(rea)o(d.)o(h)c(\(not)53
b(complete\))0 4131 y(class)f(Thread)g({)0 4244 y(public:)218
4357 y(FDTEntry)709 4373 y(*)764 4357 y(FDTable)f([MAX\\_FD];)218
4470 y(int)i(ThreadID;)218 4582 y(ThreadStatus)c(status;)218
4808 y(unsigned)i(int)874 4824 y(*)982 4808 y(stack;)218
4921 y(char)i(name)g([MAXFILENAMELE)o(NG)o(TH)48 b(+)54
b(1];)218 5147 y(int)f(userRegisters[Nu)o(mT)o(ot)o(al)o(Re)o(gs])o(;)
218 5260 y(void)g(SaveUserState\(\))o(;)218 5373 y(void)g
(RestoreUserStat)o(e\()o(\);)1927 5649 y Fe(9)p eop end
%%Page: 10 10
TeXDict begin 10 9 bop 218 91 a Fb(AddrSpace)764 107
y(*)819 91 y(space;)218 204 y(FDTEntry)709 220 y(*)764
204 y(getFD)52 b(\(int)h(fd\);)0 317 y(private:)218 430
y(unsigned)e(int)i(machineState[Ma)o(chi)o(ne)o(St)o(at)o(eS)o(ize)o
(];)0 543 y(};)0 836 y Ff(6)119 b(State/Context)30 b(Switching)0
1043 y Fe(As)22 b(we)g(can)h(see,)g(the)g(thread)h(contains)h(man)o(y)d
(of)h(the)g(same)g(structures)i(as)e(a)f(Unix)h(PCB:)e(a)h(\002le)g
(descriptor)j(table,)f(an)f(Id,)0 1155 y(and)h(a)f(current)i(status.)
141 1268 y(The)19 b(primary)h(dif)n(ference)i(between)e(a)f(Nachos)h
(thread)h(and)e(a)g(Unix)h(process)h(is)e(that)h(a)e(Nachos)i(thread)h
(contains)h Fd(tw)o(o)0 1381 y Fe(sets)g(of)g(re)o(gisters)i(and)e(tw)o
(o)f(stack)i(pointers.)30 b(This)22 b(is)f(because)j(the)e(Nachos)h
(user)n(-program)i(runs)d(on)g(a)f(MIPS)g(processor)l(,)0
1494 y(while)k(the)f(k)o(ernel)i(runs)g(on)e(a)g(host)i(processor)h
(\(in)d(this)h(case,)h(an)e(x86\).)33 b(F)o(or)23 b(this)i(reason,)h
(the)f(indi)n(vidual)i(thread)f(needs)0 1607 y Fd(tw)o(o)d
Fe(sets)i(of)e(e)n(v)o(erything)k(to)c(sa)n(v)o(e)i(its)f(conte)o(xt)h
(\(i.e.)k(it)24 b(needs)h(to)e(kno)n(w)h(where)g(it)g(w)o(as)f(in)h
(it')-5 b(s)24 b(user)g(program)h Fd(and)e Fe(where)0
1720 y(it)f(w)o(as)h(in)f(the)h(k)o(ernel\).)30 b(It)23
b(should)h(be)f(noted)g(that)h(this)f(roughly)h(corresponds)j(to)22
b(Unix,)h(which)g(maintains)h(a)e(user)n(-space)0 1833
y(stack)j(and)f(a)f(k)o(ernel)i(stack)f(for)g(each)g(process.)0
2126 y Ff(7)119 b(Multi-Pr)n(ogramming)0 2333 y Fe(Just)24
b(as)f(a)f(Unix)h(user)h(program)g(e)o(x)o(ecutes)h(inside)f(a)f
(process,)i(a)d(Nachos)i(user)g(program)g(e)o(x)o(ecutes)h(inside)f(a)f
(thread.)30 b(The)0 2445 y(follo)n(wing)c(sections)g(describe)h(the)d
(w)o(ay)g(in)h(which)f(nachos)i(manipulates)h(threads)f(while)f(in)f
(system)h(mode)g(to)f(produce)0 2558 y(multi-programming)j(and)d
(virtual)h(memory)-6 b(.)141 2671 y(Nachos)38 b(uses)g(a)e(\002x)o(ed)h
(quantum,)42 b(round-robin)e(scheduling)g(algorithm.)72
b(Thus,)40 b(when)d(one)g(thread)i(has)e(been)0 2784
y(e)o(x)o(ecuting)27 b(on)f(the)f(MIPS)f(machine)i(and)g(its)f(quantum)
i(e)o(xpires,)g(an)e(interrupt)j(is)d(triggered)i(\(a)f(simulated)h
(interrupt)g(on)0 2897 y(the)20 b(simulated)i(machine\),)g(which)f
(causes)h(a)d(trap)i(into)g(system)g(mode.)28 b(In)20
b(k)o(ernel)i(space,)f(the)g(scheduler)h(then)f(forces)h(the)0
3010 y(currently)29 b(running)g(thread)f(to)f(yield,)h(and)g(sa)n(v)o
(es)f(its)g(state.)39 b(The)27 b(scheduler)i(then)f(\002nds)f(the)g(ne)
o(xt)g(a)n(v)n(ailable)i(thread)f(on)0 3123 y(the)e(ready)g(list,)g
(restores)i(its)d(state,)i(and)e(lets)h(the)g(simulated)h(MIPS)d
(processor)k(run)e(again.)35 b(This)25 b(process)i(is)f(displayed)0
3236 y(in)d(Figure)i(5,)d(belo)n(w)-6 b(.)600 4824 y
@beginspecial 0 @llx 0 @lly 702 @urx 382 @ury 3240 @rwi
@setspecial
%%BeginDocument: figures/nachos3.eps
%!PS-Adobe-2.0 EPSF
%%Title: /tmp/xfig-fig000712
%%Creator: fig2dev
%%CreationDate: Wed Oct 30 20:46:52 1996
%%For: rhill@dante (Robert Hill)
%%BoundingBox: 0 0 702 382
%%Pages: 0
%%EndComments
/$F2psDict 200 dict def 
$F2psDict begin
$F2psDict /mtrx matrix put
/l {lineto} bind def
/m {moveto} bind def
/s {stroke} bind def
/n {newpath} bind def
/gs {gsave} bind def
/gr {grestore} bind def
/clp {closepath} bind def
/graycol {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
4 -2 roll mul setrgbcolor} bind def
/col-1 {} def
/col0 {0 0 0 setrgbcolor} bind def
/col1 {0 0 1 setrgbcolor} bind def
/col2 {0 1 0 setrgbcolor} bind def
/col3 {0 1 1 setrgbcolor} bind def
/col4 {1 0 0 setrgbcolor} bind def
/col5 {1 0 1 setrgbcolor} bind def
/col6 {1 1 0 setrgbcolor} bind def
/col7 {1 1 1 setrgbcolor} bind def
	end
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def
%%EndProlog

$F2psBegin
0 setlinecap 0 setlinejoin
-27.0 445.0 translate 0.900 -0.900 scale
0.500 setlinewidth
% Polyline
n 369 419 m 369 319 l  279 319 l  279 419 l 
 clp gs col-1 s gr
% Polyline
n 349 414 m 349 379 l  284 379 l  284 414 l 
 clp gs col-1 s gr
% Polyline
n 284 384 m 284 384 l  284 384 l  284 384 l 
 clp gs col-1 s gr
% Polyline
n 309 389 m 309 384 l  289 384 l  289 389 l 
 clp gs col-1 s gr
% Polyline
n 339 389 m 339 384 l  319 384 l  319 389 l 
 clp gs col-1 s gr
% Polyline
n 309 399 m 309 394 l  289 394 l  289 399 l 
 clp gs col-1 s gr
% Polyline
n 309 409 m 309 404 l  289 404 l  289 409 l 
 clp gs col-1 s gr
% Polyline
n 339 399 m 339 394 l  319 394 l  319 399 l 
 clp gs col-1 s gr
% Polyline
n 339 409 m 339 404 l  319 404 l  319 409 l 
 clp gs col-1 s gr
/Times-Roman findfont 12.00 scalefont setfont
289 314 m 
gs 1 -1 scale (T1) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
284 374 m 
gs 1 -1 scale (Context) col-1 show gr
% Polyline
n 584 264 m 584 254 l  534 254 l  534 264 l 
 clp gs col-1 s gr
% Polyline
n 584 279 m 584 269 l  534 269 l  534 279 l 
 clp gs col-1 s gr
% Polyline
n 584 294 m 584 284 l  534 284 l  534 294 l 
 clp gs col-1 s gr
% Polyline
n 644 294 m 644 284 l  594 284 l  594 294 l 
 clp gs col-1 s gr
% Polyline
n 644 279 m 644 269 l  594 269 l  594 279 l 
 clp gs col-1 s gr
% Polyline
n 644 264 m 644 254 l  594 254 l  594 264 l 
 clp gs col-1 s gr
% Polyline
n 649 304 m 649 244 l  529 244 l  529 304 l 
 clp gs col-1 s gr
% Polyline
n 631 227 m 631 212 l  531 212 l  531 227 l 
 clp gs col-1 s gr
/Times-Roman findfont 10.00 scalefont setfont
536 224 m 
gs 1 -1 scale (Program Counter) col-1 show gr
n 397.358 277.081 m 399.000 269.000 l 401.354 276.903 l gs 2 setlinejoin col-1 s gr
	1 setlinecap [1 3.000000] 3.000000 setdash
n 493.605 264.789 94.699 95.821 177.451 arc
gs col-1 s gr
	[] 0 setdash 0 setlinecap
n 641.460 206.155 m 644.000 214.000 l 638.067 208.273 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 474.310 319.923 200.036 -128.788 -31.973 arc
gs col-1 s gr
	[] 0 setdash
n 368.683 415.788 m 364.000 409.000 l 371.326 412.786 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 478.853 278.559 173.799 11.766 131.364 arc
gs col-1 s gr
	[] 0 setdash
% Polyline
n 36 146 m 29 146 29 247 7 arcto 4 {pop} repeat 29 254 207 254 7 arcto 4 {pop} repeat 214 254 214 153 7 arcto 4 {pop} repeat 214 146 36 146 7 arcto 4 {pop} repeat clp gs col-1 s gr
% Polyline
n 344 194 m 344 159 l  279 159 l  279 194 l 
 clp gs col-1 s gr
% Polyline
n 304 169 m 304 164 l  284 164 l  284 169 l 
 clp gs col-1 s gr
% Polyline
n 334 169 m 334 164 l  314 164 l  314 169 l 
 clp gs col-1 s gr
% Polyline
n 304 179 m 304 174 l  284 174 l  284 179 l 
 clp gs col-1 s gr
% Polyline
n 334 179 m 334 174 l  314 174 l  314 179 l 
 clp gs col-1 s gr
% Polyline
n 304 189 m 304 184 l  284 184 l  284 189 l 
 clp gs col-1 s gr
% Polyline
n 334 189 m 334 184 l  314 184 l  314 189 l 
 clp gs col-1 s gr
% Polyline
n 364 199 m 364 100 l  274 100 l  274 199 l 
 clp gs col-1 s gr
% Polyline
n 364 279 m 364 199 l  274 199 l  274 279 l 
 clp gs col-1 s gr
% Polyline
n 369 484 m 369 419 l  279 419 l  279 484 l 
 clp gs col-1 s gr
% Polyline
n 719 329 m 719 189 l  519 189 l  519 329 l 
 clp gs col-1 s gr
% Polyline
n 529 224 m 494 224 l  494 464 l  344 464 l gs col-1 s gr
n 352.000 466.000 m 344.000 464.000 l 352.000 462.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 529 214 m 449 214 l  449 244 l  334 244 l gs col-1 s gr
n 342.000 246.000 m 334.000 244.000 l 342.000 242.000 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 809 494 m 809 69 l  229 69 l  229 494 l 
 clp gs col-1 s gr
	[] 0 setdash
/Times-Roman findfont 10.00 scalefont setfont
39 166 m 
gs 1 -1 scale (next = Find_Next_To_Run) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 181 m 
gs 1 -1 scale (current_thread->save_state) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 198 m 
gs 1 -1 scale (current_thread = next;) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 214 m 
gs 1 -1 scale (next->restore_state) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 235 m 
gs 1 -1 scale (reset_timer\(\)) col-1 show gr
/Times-Roman findfont 13.00 scalefont setfont
34 141 m 
gs 1 -1 scale (Scheduler) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
284 94 m 
gs 1 -1 scale (T2) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
284 154 m 
gs 1 -1 scale (Context) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
279 214 m 
gs 1 -1 scale (Address Space) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
284 434 m 
gs 1 -1 scale (Address Space) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
529 459 m 
gs 1 -1 scale (T1.save_state\(\)) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
444 109 m 
gs 1 -1 scale (T2.restore_state) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 369 m 
gs 1 -1 scale (PC1) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
404 279 m 
gs 1 -1 scale (PC2) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
529 184 m 
gs 1 -1 scale (MIPS Simulator) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
534 241 m 
gs 1 -1 scale (MIPS registers) col-1 show gr
$F2psEnd

%%EndDocument
 @endspecial 1432 5020 a(Figure)24 b(5:)29 b(Conte)o(xt)24
b(Switching)141 5233 y(As)g(described)j(in)e(the)g(pre)n(vious)i
(section,)f(when)f(a)g(Nachos)g(thread)h(does)g(a)e(conte)o(xt)i
(switch)g(it)e(must)h(sa)n(v)o(e)g(tw)o(o)g(sets)0 5346
y(of)h(re)o(gisters.)37 b(This)25 b(can)i(be)e(seen)i(in)f(the)g(code)g
(for)g Fc(Sc)o(heduler::Run\(\))p Fe(,)k(seen)d(belo)n(w)-6
b(.)35 b(This)26 b(function)i(is)d(usually)j(called)1905
5649 y(10)p eop end
%%Page: 11 11
TeXDict begin 11 10 bop 0 91 a Fe(when)24 b(the)f(current)j(thread')-5
b(s)25 b(quantum)g(has)f(e)o(xpired,)h(and)f(a)f(ne)n(w)g(thread)i
(needs)f(to)g(be)f(switched)i(in.)1905 5649 y(11)p eop
end
%%Page: 12 12
TeXDict begin 12 11 bop 0 91 a Fb(void)0 204 y(Scheduler::Run)48
b(\(Thread)1255 220 y(*)1310 204 y(nextThread\))0 317
y({)218 430 y(Thread)600 446 y(*)655 430 y(oldThread)i(=)k
(currentThread;)218 656 y(if)g(\(currentThread)o(->s)o(pa)o(ce)48
b(!=)53 b(NULL\))g({)436 769 y(currentThread->S)o(av)o(eU)o(se)o(rS)o
(tat)o(e\()o(\);)436 882 y(currentThread->s)o(pa)o(ce)o(->)o(Sa)o(veS)o
(ta)o(te)o(\(\))o(;)218 995 y(})218 1220 y(currentThread)c(=)54
b(nextThread;)218 1333 y(currentThread->)o(se)o(tSt)o(at)o(us)o(\(R)o
(UN)o(NIN)o(G\))o(;)218 1559 y(SWITCH\(oldThrea)o(d,)48
b(nextThread\);)218 1785 y(if)54 b(\(threadToBeDes)o(tro)o(ye)o(d)48
b(!=)54 b(NULL\))e({)436 1898 y(delete)g(threadToBeDestr)o(oy)o(ed;)436
2011 y(threadToBeDestro)o(ye)o(d)c(=)54 b(NULL;)218 2124
y(})218 2350 y(if)g(\(currentThread)o(->s)o(pa)o(ce)48
b(!=)53 b(NULL\))g({)436 2462 y(currentThread->R)o(es)o(to)o(re)o(Us)o
(erS)o(ta)o(te)o(\(\))o(;)436 2575 y(currentThread->s)o(pa)o(ce)o(->)o
(Re)o(sto)o(re)o(St)o(at)o(e\()o(\);)218 2688 y(})0 2801
y(})141 2986 y Fe(This)31 b(function)j(is)d(called)h(with)g(a)e
(pointer)j(to)f(the)f(ne)o(xt)h(thread)h(to)e(run.)52
b(The)31 b(scheduler)j(then)e(sa)n(v)o(es)g(the)g(current)0
3098 y(threads)c(state)e(\(there)h(are)f(tw)o(o)g(calls)h(here,)g(the)f
(\002rst)f(one)i(is)e(for)h(the)h(user)n(-state)h(MIPS)c(re)o(gister)l
(,)k(the)f(second)g(is)f(to)g(sa)n(v)o(e)0 3211 y(the)20
b(page)h(table)f(from)g(the)g(machine\).)29 b(W)-7 b(e)19
b(then)h(set)g(the)g(ne)n(w)f(thread')-5 b(s)22 b(status)f(to)e
(running)j(and)e(call)h(a)e(machine)i(language)0 3324
y(routine)j Fc(SWITCH)p Fe(.)c(This)i(sa)n(v)o(es)h(the)f(host)h
(machine)g(re)o(gisters)h(associated)h(with)c(the)i(\002rst)e(thread,)j
(and)e(then)h(restores)h(the)0 3437 y(re)o(gisters)h(associated)i(with)
c(the)h(ne)n(w)f(thread.)141 3550 y(It)j(should)i(be)e(noted)h(that,)g
(on)f(return)h(from)f Fc(SWITCH)p Fe(,)e(a)i Fd(differ)n(ent)h(thr)n
(ead)f Fe(is)g(e)o(x)o(ecuting.)38 b(If)26 b(the)g(switch)g(is)g(from)0
3663 y(Thread)j(1)f(to)g(Thread)g(2,)h(going)g(into)g
Fc(SWITCH)e Fe(Thread)i(1)e(is)h(running,)j(coming)e(out)g(of)f
Fc(SWITCH)p Fe(,)e(Thread)j(2)f(is)g(no)n(w)0 3776 y(running,)i(Thread)
f(1)e(has)h(been)h(put)f(back)g(on)g(the)g(ready)g(list,)h(for)f
(resumption)i(later)e(\(note:)39 b(Thread)28 b(1')-5
b(s)28 b(host)h(PC)d(still)0 3889 y(points)f(to)e Fc(SWITCH)p
Fe(,)f(so)i(that)g(when)f(it)h(resumes)g(later)h(it)e(will)g(resume)h
(from)g(there\).)0 4177 y Ff(8)119 b(Running)32 b(User)e(Pr)n(ograms)0
4384 y Fe(A)g(Nachos)j(thread)f(e)o(xists)h(primarily)g(to)e(run)h
(user)g(programs.)54 b(T)-7 b(o)31 b(do)g(this,)j(the)e(thread)h
(object)g(has)f(a)f(pointer)i(to)e(an)0 4497 y(address)25
b(space)g(object,)g(which)f(has)f(a)h(page)g(table)g(inside)h(it.)141
4610 y(T)-7 b(o)26 b(run)h(a)g(user)g(program,)i(the)e(thread)h(must)f
(ha)n(v)o(e)h(control)g(of)f(the)g(MIPS)f(simulator)-5
b(.)40 b(When)27 b(this)h(is)f(the)g(case,)h(the)0 4723
y(thread')-5 b(s)25 b(user)f(program)h(will)e(be)g(resident)i(in)f
(main)f(memory)g(and)h(the)g(machine')-5 b(s)25 b(program)f(counter)i
(will)d(be)g(pointing)0 4835 y(to)h(an)f(instruction)k(some)n(where)e
(in)e(that)i(memory)-6 b(.)29 b(Then)24 b(the)g(machine)h(in)l(v)n(ok)o
(es)h(Run\(\),)e(which)g(simply)g(loops)h(through)0 4948
y(a)34 b(fetch-and-e)o(x)o(ecute)k(c)o(ycle,)g(reading)d(instructions)j
(from)c(main)g(memory)g(and)h(e)o(x)o(ecuting)h(them)e(until)h(the)f
(threads)0 5061 y(quantum)25 b(e)o(xpires)g(and)f(the)g(scheduler)i(sw)
o(aps)e(it)f(out.)29 b(The)23 b(user)h(program)h(e)o(x)o(ecution)h
(process)f(is)e(diagramed)j(belo)n(w:)141 5174 y(Nachos)31
b(assumes)g(that)f(only)h(a)e(single)i(user)g(program)g(e)o(xists)f(at)
g(a)f(gi)n(v)o(en)h(time.)48 b(Thus,)31 b(when)f(an)f(address)j(space)0
5287 y(is)e(created,)k(Nachos)d(assumes)h(that)f(no)f(one)h(else)g(is)f
(using)i(physical)g(memory)f(and)g(simply)g(zeros)g(out)g(all)g(of)f
(physi-)0 5400 y(cal)f(memory)h(\(e.g.,)g(the)g(mainMemory)g(character)
h(array\).)48 b(Nachos)30 b(then)g(reads)g(the)f(binary)i(into)f
(physical)h(memory)1905 5649 y(12)p eop end
%%Page: 13 13
TeXDict begin 13 12 bop 600 1633 a @beginspecial 0 @llx
0 @lly 625 @urx 378 @ury 3240 @rwi @setspecial
%%BeginDocument: figures/nachos2.eps
%!PS-Adobe-2.0 EPSF
%%Title: /tmp/xfig-fig000712
%%Creator: fig2dev
%%CreationDate: Wed Oct 30 20:46:36 1996
%%For: rhill@dante (Robert Hill)
%%BoundingBox: 0 0 625 378
%%Pages: 0
%%EndComments
/$F2psDict 200 dict def 
$F2psDict begin
$F2psDict /mtrx matrix put
/l {lineto} bind def
/m {moveto} bind def
/s {stroke} bind def
/n {newpath} bind def
/gs {gsave} bind def
/gr {grestore} bind def
/clp {closepath} bind def
/graycol {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
4 -2 roll mul setrgbcolor} bind def
/col-1 {} def
/col0 {0 0 0 setrgbcolor} bind def
/col1 {0 0 1 setrgbcolor} bind def
/col2 {0 1 0 setrgbcolor} bind def
/col3 {0 1 1 setrgbcolor} bind def
/col4 {1 0 0 setrgbcolor} bind def
/col5 {1 0 1 setrgbcolor} bind def
/col6 {1 1 0 setrgbcolor} bind def
/col7 {1 1 1 setrgbcolor} bind def
	end
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def
%%EndProlog

$F2psBegin
0 setlinecap 0 setlinejoin
-45.0 454.0 translate 0.900 -0.900 scale
0.500 setlinewidth
n 334.367 322.739 m 329.000 329.000 l 330.789 320.950 l gs 2 setlinejoin col-1 s gr
n 304.000 316.500 27.951 -100.305 26.565 arc
gs col-1 s gr
n 382.096 417.433 m 374.000 419.000 l 380.406 413.808 l gs 2 setlinejoin col-1 s gr
n 362.804 394.978 26.503 -52.330 65.011 arc
gs col-1 s gr
n 228.608 442.237 m 229.000 434.000 l 232.530 441.452 l gs 2 setlinejoin col-1 s gr
n 241.500 431.500 12.748 11.310 168.690 arc
gs col-1 s gr
n 87.006 383.369 m 94.000 379.000 l 89.885 386.146 l gs 2 setlinejoin col-1 s gr
n 108.868 393.342 20.658 89.634 -136.032 arc
gs col-1 s gr
n 285.875 357.589 m 294.000 359.000 l 286.167 361.578 l gs 2 setlinejoin col-1 s gr
n 301.500 461.500 102.774 -138.945 -94.185 arc
gs col-1 s gr
n 280.754 369.063 m 289.000 369.000 l 281.754 372.936 l gs 2 setlinejoin col-1 s gr
n 295.667 394.833 26.680 -178.211 -104.471 arc
gs col-1 s gr
% Polyline
n 454 449 m 454 449 l  454 449 l  454 449 l 
 clp gs col-1 s gr
% Polyline
n 306 339 m 299 339 299 362 7 arcto 4 {pop} repeat 299 369 417 369 7 arcto 4 {pop} repeat 424 369 424 346 7 arcto 4 {pop} repeat 424 339 306 339 7 arcto 4 {pop} repeat clp gs col-1 s gr
% Polyline
n 261 399 m 254 399 254 422 7 arcto 4 {pop} repeat 254 429 362 429 7 arcto 4 {pop} repeat 369 429 369 406 7 arcto 4 {pop} repeat 369 399 261 399 7 arcto 4 {pop} repeat clp gs col-1 s gr
% Polyline
n 126 399 m 119 399 119 422 7 arcto 4 {pop} repeat 119 429 227 429 7 arcto 4 {pop} repeat 234 429 234 406 7 arcto 4 {pop} repeat 234 399 126 399 7 arcto 4 {pop} repeat clp gs col-1 s gr
% Polyline
n 454 449 m 454 109 l  49 109 l  49 449 l 
 clp gs col-1 s gr
% Polyline
n 49 249 m 454 249 l  454 249 l gs col-1 s gr
% Polyline
n 71 344 m 64 344 64 367 7 arcto 4 {pop} repeat 64 374 172 374 7 arcto 4 {pop} repeat 179 374 179 351 7 arcto 4 {pop} repeat 179 344 71 344 7 arcto 4 {pop} repeat clp gs col-1 s gr
% Polyline
n 181 274 m 174 274 174 297 7 arcto 4 {pop} repeat 174 304 282 304 7 arcto 4 {pop} repeat 289 304 289 281 7 arcto 4 {pop} repeat 289 274 181 274 7 arcto 4 {pop} repeat clp gs col-1 s gr
% Polyline
n 239 234 m 239 214 l  64 214 l  64 234 l 
 clp gs col-1 s gr
% Polyline
n 239 204 m 239 184 l  64 184 l  64 204 l 
 clp gs col-1 s gr
% Polyline
n 239 174 m 239 154 l  64 154 l  64 174 l 
 clp gs col-1 s gr
% Polyline
n 224 164 m 259 164 l  259 239 l  499 239 l gs col-1 s gr
n 491.000 237.000 m 499.000 239.000 l 491.000 241.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 724 449 m 724 234 l  499 234 l  499 449 l 
 clp gs col-1 s gr
% Polyline
n 439 224 m 439 134 l  274 134 l  274 224 l 
 clp gs col-1 s gr
% Polyline
n 479 84 m 479 504 l  479 499 l  479 494 l gs col-1 s gr
% Polyline
n 724 94 m 724 204 l  499 204 l  499 94 l 
 clp gs col-1 s gr
% Polyline
n 624 169 m 624 154 l  504 154 l  504 169 l 
 clp gs col-1 s gr
% Polyline
n 624 194 m 624 179 l  504 179 l  504 194 l 
 clp gs col-1 s gr
% Polyline
n 499 269 m 524 259 l  559 269 l  594 259 l 
 604 269 l  609 259 l  619 274 l  624 264 l  639 264 l 
 644 254 l  659 269 l gs col-1 s gr
n 659 269 m 664 264 l  674 269 l  684 254 l 
 694 264 l  699 254 l  709 264 l  724 259 l  724 264 l gs col-1 s gr
% Polyline
n 499 384 m 514 379 l  529 389 l  544 379 l 
 559 389 l  569 379 l  599 389 l  604 374 l  609 384 l 
 619 379 l  629 384 l gs col-1 s gr
n 629 384 m 639 374 l  654 384 l  664 374 l 
 674 384 l  684 374 l  704 384 l  709 374 l  714 379 l 
 724 374 l gs col-1 s gr
n 617.000 321.000 m 609.000 319.000 l 617.000 317.000 l gs 2 setlinejoin col-1 s gr
% Polyline
n 609 319 m 744 319 l  744 159 l  599 159 l gs col-1 s gr
/Times-Roman findfont 12.00 scalefont setfont
94 99 m 
gs 1 -1 scale (Thread 1) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
189 294 m 
gs 1 -1 scale (JUST_CREATED) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
314 359 m 
gs 1 -1 scale (READY) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
269 419 m 
gs 1 -1 scale (RUNNING) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
134 419 m 
gs 1 -1 scale (BLOCKED) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
79 364 m 
gs 1 -1 scale (ZOMBIE) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
69 229 m 
gs 1 -1 scale (Machine State \(HOST\)) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
69 199 m 
gs 1 -1 scale (Machine State \(MIPS\)) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
69 169 m 
gs 1 -1 scale (Address Space) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
69 139 m 
gs 1 -1 scale (Process Control Block) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
284 154 m 
gs 1 -1 scale (ThreadId) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
284 174 m 
gs 1 -1 scale (Name) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
284 194 m 
gs 1 -1 scale (File Descriptor Table) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
509 119 m 
gs 1 -1 scale (MIPS SIMULATOR) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
509 279 m 
gs 1 -1 scale (pushl %ebx) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
509 294 m 
gs 1 -1 scale (movl %esp, %ebp) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
509 309 m 
gs 1 -1 scale (subl $16, %esp) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
509 324 m 
gs 1 -1 scale (leal -12\(%ebp\),%ebx) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
509 339 m 
gs 1 -1 scale (call __myfunction) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
509 354 m 
gs 1 -1 scale (addl $4, %exp) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
509 369 m 
gs 1 -1 scale (pushl $1) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
59 274 m 
gs 1 -1 scale (STATE) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
509 165 m 
gs 1 -1 scale (Program Counter) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
509 191 m 
gs 1 -1 scale (User Stack Pointer) col-1 show gr
$F2psEnd

%%EndDocument
 @endspecial 1308 1829 a Fe(Figure)24 b(6:)29 b(Ex)o(ecuting)c(a)e
(User)g(Process)0 2106 y(starting)29 b(at)e(location)i(mainMemory)e
(and)h(initializes)h(the)f(translation)i(tables)e(to)f(do)f(a)h
(one-to-one)j(mapping)e(between)0 2219 y(virtual)23 b(and)g(physical)g
(addresses)i(\(e.g.,)c(so)h(that)g(an)o(y)g(virtual)i(address)f(N)e
(maps)h(directly)i(into)e(the)g(physical)i(address)f(N\).)0
2332 y(Initialization)k(of)d(re)o(gisters)h(consists)h(of)e(zeroing)h
(them)f(all)g(out,)f(setting)j(PCRe)o(g)c(and)i(Ne)o(xtPCRe)o(g)e(to)i
(0)f(and)h(4)g(respec-)0 2445 y(ti)n(v)o(ely)-6 b(,)29
b(and)f(setting)h(the)f(stackpointer)k(to)27 b(the)h(lar)n(gest)h
(virtual)h(address)f(of)f(the)g(process)h(\(the)f(stack)h(gro)n(ws)e
(do)n(wnw)o(ard)0 2558 y(to)n(w)o(ards)h(the)f(heap)i(and)e(te)o(xt\).)
40 b(Nachos)28 b(assumes)h(that)e(e)o(x)o(ecution)j(of)d(user)n
(-programs)j(be)o(gins)f(at)e(the)g(\002rst)g(instruction)0
2670 y(in)c(the)h(te)o(xt)g(se)o(gment)g(\(e.g.,)f(virtual)i(address)h
(0\).)141 2783 y(When)35 b(support)h(for)f(multiple)h(user)f(processes)
i(has)e(been)h(added,)i(tw)o(o)c(other)i(Nachos)f(routines)i(are)e
(necessary)0 2896 y(for)29 b(process)h(switching.)47
b(Whene)n(v)o(er)29 b(the)g(current)i(processes)g(is)e(suspended)i
(\(e.g.,)f(preempted)g(or)f(put)g(to)g(sleep\),)i(the)0
3009 y(scheduler)e(in)l(v)n(ok)o(es)g(the)e(routine)h
Fc(AddrSpace::SaveUserSta)q(te\()q(\))p Fe(,)k(in)26
b(order)i(to)e(properly)i(sa)n(v)o(e)f(address-space)k(related)0
3122 y(state)j(that)f(the)g(lo)n(w-le)n(v)o(el)g(thread)h(switching)h
(routines)f(do)f(not)g(kno)n(w)g(about.)57 b(This)33
b(becomes)h(necessary)h(when)e(us-)0 3235 y(ing)e(virtual)i(memory;)i
(when)d(switching)g(from)f(one)h(process)h(to)e(another)l(,)k(a)30
b(ne)n(w)h(set)g(of)g(address)i(translation)h(tables)0
3348 y(needs)24 b(to)f(be)g(loaded.)30 b(The)23 b(Nachos)h(scheduler)h
(calls)f Fc(SaveUserState\(\))j Fe(whene)n(v)o(er)d(it)f(is)g(about)h
(to)f(preempt)h(one)g(thread)0 3461 y(and)37 b(switch)h(to)f(another)-5
b(.)71 b(Lik)o(e)n(wise,)40 b(before)f(switching)f(to)f(a)g(ne)n(w)f
(thread,)41 b(the)d(Nachos)g(scheduler)h(in)l(v)n(ok)o(es)h
Fc(Ad-)0 3574 y(drSpace::Restor)m(eUserSta)q(te)p Fe(.)34
b Fc(Restor)m(eUserState\(\))27 b Fe(insures)e(that)e(the)h(proper)g
(address)h(translation)h(tables)e(are)g(loaded)0 3687
y(before)h(e)o(x)o(ecution)g(resumes.)0 3936 y Fa(8.1)99
b(System)25 b(Calls)f(and)i(Exception)g(Handling)0 4110
y Fe(User)31 b(programs)i(in)l(v)n(ok)o(e)g(system)f(calls)g(by)f(e)o
(x)o(ecuting)i(the)f(MIPS)d Fc("syscall")k Fe(instruction,)j(which)c
(generates)h(a)e(hard-)0 4223 y(w)o(are)e(trap)g(into)g(the)g(Nachos)g
(k)o(ernel.)46 b(The)28 b(Nachos/MIPS)h(simulator)h(implements)g(traps)
g(by)f(in)l(v)n(oking)i(the)e(Routine)0 4336 y Fc(RaiseException\(\))p
Fe(,)f(passing)e(it)e(ar)n(guments)j(indicating)g(the)e(e)o(xact)g
(cause)g(of)f(the)h(trap.)32 b Fc(RaiseException)p Fe(,)27
b(in)d(turn,)h(calls)0 4449 y Fc(ExceptionHandler)j Fe(to)c(tak)o(e)g
(care)h(of)f(the)g(speci\002c)h(problem.)31 b Fc(ExceptionHandler)c
Fe(is)d(passed)i(a)d(single)i(ar)n(gument)h(indi-)0 4562
y(cating)f(the)f(precise)h(cause)g(of)e(the)h(trap.)141
4675 y(The)i Fc("syscall")i Fe(instruction)h(indicates)g(a)c(system)i
(call)g(is)f(requested,)j(b)n(ut)e(doesn')n(t)h(indicate)g(which)f
(system)g(call)f(to)0 4788 y(perform.)i(By)18 b(con)l(v)o(ention,)k
(user)e(programs)g(place)f(the)g(code)g(indicating)j(the)d(particular)i
(system)e(call)g(desired)h(in)f(re)o(gister)0 4900 y(r2)30
b(before)g(e)o(x)o(ecuting)i(the)e Fc("syscall")h Fe(instruction.)50
b(Additional)32 b(ar)n(guments)g(to)e(the)f(system)i(call)f(\(when)g
(appropriate\))0 5013 y(can)25 b(be)f(found)h(in)g(re)o(gisters)h
(r4-r7,)f(follo)n(wing)h(the)e(standard)i(C)e(procedure)i(call)f
(linkage)h(con)l(v)o(entions.)35 b(Function)25 b(\(and)0
5126 y(system)f(call\))h(return)f(v)n(alues)h(are)f(e)o(xpected)h(to)f
(be)f(in)h(re)o(gister)h(r2)e(on)h(return.)141 5239 y(W)-7
b(arning:)28 b(When)19 b(accessing)i(user)e(memory)g(from)f(within)h
(the)g(e)o(xception)i(handler)f(\(or)f(within)g(Nachos)g(in)f
(general\),)0 5352 y(user)n(-le)n(v)o(el)36 b(addresses)g(cannot)g(be)e
(referenced)i(directly)-6 b(.)62 b(Recall)34 b(that)h(user)n(-le)n(v)o
(el)h(processes)g(e)o(x)o(ecute)f(in)f(their)h(o)n(wn)1905
5649 y(13)p eop end
%%Page: 14 14
TeXDict begin 14 13 bop 0 91 a Fe(pri)n(v)n(ate)26 b(address)h(spaces,)
f(which)f(the)h(k)o(ernel)g(cannot)g(reference)i(directly)-6
b(.)34 b(Attempts)26 b(to)f(dereference)j(pointers)f(passed)0
204 y(as)h(ar)n(guments)j(to)e(system)g(calls)g(will)f(lik)o(ely)i
(lead)f(to)g(problems)h(\(e.g.,)f(se)o(gmentation)i(f)o(aults\))f(if)e
(referenced)j(directly)-6 b(.)0 317 y(Use)23 b Fc(ReadMem)g
Fe(and)h Fc(WriteMem)g Fe(to)f(dereference)k(pointers)f(passed)f(as)e
(ar)n(guments)j(to)d(system)i(calls.)0 610 y Ff(9)119
b(Memory)29 b(Management)0 817 y Fe(Nachos)e(uses)f(paging)i(to)e(gi)n
(v)o(e)g(its)g(threads)h(contiguous)j(logical)d(address)h(spaces.)37
b(These)26 b(logical)i(address)g(spaces)f(are)0 930 y(128)h(kilobytes)i
(in)d(size,)i(e)n(v)o(en)f(though)h(the)e(simulated)j(MIPS)25
b(processor)30 b(on)e(which)g(the)o(y)f(run)h(has)g(only)g(16)g
(kilobytes)0 1043 y(of)g(main)h(memory)-6 b(.)43 b(In)28
b(order)h(to)g(accomplish)h(this,)g(a)e(virtual)i(memory)e(scheme)i(is)
e(used.)44 b(In)28 b(this)h(scheme,)h(pages)f(of)0 1155
y(memory)23 b(that)g(are)g(not)g(in)g(use)g(are)g(sw)o(apped)h(out)f
(to)g(a)f(disk)i(\002le,)e(from)h(which)g(the)o(y)g(are)g(read)g(back)h
(into)f(memory)g(when)0 1268 y(the)o(y)h(are)g(needed.)141
1381 y(As)29 b(with)g(most)g(modern)i(computer)g(systems,)g(paging)g
(is)f(achie)n(v)o(ed)h(through)g(the)f(use)g(of)f(memory)g(management)0
1494 y(unit)c(\(MMU\).)e(The)g Fc(MemoryMana)o(g)o(er)k
Fe(and)e Fc(Mac)o(hine)g Fe(objects)g(together)i(serv)o(e)d(as)h(the)f
(MMU)f(of)h(the)g(nachos)i(system.)0 1607 y(The)d Fc(MemoryMana)o(g)o
(er)j Fe(object)f(k)o(eeps)g(track)f(of)g(which)g(physical)h(memory)f
(pages)h(are)e(free,)h(which)g(are)g(used,)g(and)g(the)0
1720 y(o)n(wners)29 b(of)g(the)h(used)f(pages.)46 b(As)29
b(such,)h(it)f(is)g(primarily)h(in)l(v)n(olv)o(ed)i(in)d(memory)g
(resource)i(allocation.)48 b(The)28 b Fc(Mac)o(hine)0
1833 y Fe(object,)d(among)f(other)g(things,)h(holds)g(the)f(page)g
(table)g(of)g(the)g(currently)i(running)f(Nachos)g(thread.)141
1946 y(Since)30 b(each)h(Nachos)g(thread)g(is)f(vie)n(wed)h(as)f(a)f
(process)j(with)e(its)g(o)n(wn)f(contiguous)34 b(logical)d(address)h
(space,)g(each)0 2059 y(thread)21 b(needs)f(its)g(o)n(wn)f(page)h
(table.)28 b(In)20 b(Unix,)g(a)f(pointer)i(to)e(a)g(process')-5
b(s)22 b(page)e(table)h(is)e(stored)i(in)e(its)h(PCB.)d(As)i(described)
0 2172 y(earlier)l(,)26 b(the)f(Nachos)g(equi)n(v)n(alent)i(of)d(the)h
(PCB)d(is)j(the)f Fc(Thr)m(ead)h Fe(object,)h(which)f(maintains)h(all)e
(the)h(information)i(that)e(the)0 2285 y(k)o(ernel)31
b(needs)g(to)e(kno)n(w)h(about)g(a)f(thread.)48 b(One)29
b(of)h(the)g(items)f(in)h(the)g Fc(Thr)m(ead)g Fe(object)g(is)g(a)f
(pointer)i(to)f(an)f Fc(AddrSpace)0 2398 y Fe(object.)40
b(This)27 b(object)h(is)f(simply)g(an)g(abstraction)j(of)d(the)g
(thread')-5 b(s)29 b(logical)g(address)f(space,)h(and)e(contains)i(a)e
(pointer)h(to)0 2510 y(the)23 b(thread')-5 b(s)25 b(page)f(table.)30
b(When)23 b(the)h(CPU)d(is)h(gi)n(v)o(en)i(to)f(the)g(thread,)i(the)e
(page)h(table)g(in)f(the)g Fc(Mac)o(hine)h Fe(object)h(is)e(loaded)0
2623 y(using)i(this)f(pointer)-5 b(.)141 2736 y(Figure)24
b(7)f(sho)n(ws)h(ho)n(w)f(page)h(tables)h(are)f(used)g(to)g(gi)n(v)o(e)
f(Nachos)i(threads)g(contiguous)i(logical)e(address)g(spaces.)141
2849 y(The)31 b(thread')-5 b(s)33 b(page)f(table)g(is)f(implemented)i
(as)e(an)g(array)h(of)f Fc(T)-5 b(r)o(anslationEntry)34
b Fe(objects,)h(with)c(one)g Fc(T)-5 b(r)o(anslatio-)0
2962 y(nEntry)25 b Fe(object)h(for)e(each)i(page)f(of)f(the)h(thread')
-5 b(s)26 b(logical)g(address)g(space.)33 b(The)24 b
Fc(T)-5 b(r)o(anslationEntry)27 b Fe(class)f(is)e(declared)i(as)0
3075 y(follo)n(ws:)0 3288 y Fb(class)52 b(TranslationEntr)o(y)d({)109
3400 y(public:)218 3513 y(unsigned)i(int)i(virtualPage;)218
3626 y(unsigned)e(int)i(physicalPage;)218 3739 y(bool)g(valid;)218
3852 y(bool)g(readOnly;)218 3965 y(bool)g(use;)218 4078
y(bool)g(dirty;)218 4191 y(OpenFile)658 4207 y(*)764
4191 y(File;)218 4304 y(size_t)f(offset;)218 4417 y(bool)h(zero;)218
4530 y(bool)g(cow;)598 b(//)54 b(Copy)e(on)i(write)0
4642 y(};)141 4855 y Fe(The)20 b(most)h(ob)o(vious)h(function)h(of)e
(the)g Fc(T)-5 b(r)o(anslationEntry)24 b Fe(object)e(is)e(to)h(hold)g
(the)g(virtual)h(to)f(physical)h(page)g(mapping)0 4968
y(of)30 b(a)f(page.)48 b(In)29 b(addition,)k(it)d(also)g(has)g(a)f
Fc(valid)i Fe(member)e(whose)i(v)n(alue)f(indicates)i(whether)f(the)f
(page)g(is)g(\223v)n(alid\224)h(\(i.e.)0 5081 y(has)f(not)g(been)g(sw)o
(apped)h(out)f(of)f(main)h(memory\).)47 b(It)29 b(also)h(contains)i
(members)e(to)f(indicate)j(the)d(read-only)k(status)d(of)0
5194 y(the)c(page)h(\(program)h(te)o(xt)e(pages)h(are)f(usually)i
(considered)h(read-only\),)g(use)d(of)g(the)h(page)g(\(set)f(e)n(v)o
(ery)g(time)g(the)h(page)f(is)0 5307 y(referenced)g(by)e(the)g(hardw)o
(are\),)h(and)f(whether)g(or)g(not)g(the)f(page)i(has)f(been)g
(modi\002ed)g(\(whether)h(or)e(not)h(it)g(is)f(\223dirty\224\).)1905
5649 y(14)p eop end
%%Page: 15 15
TeXDict begin 15 14 bop 600 2467 a @beginspecial 0 @llx
0 @lly 522 @urx 477 @ury 3240 @rwi @setspecial
%%BeginDocument: figures/nachos7.eps
%!PS-Adobe-2.0 EPSF
%%Title: /tmp/xfig-fig000712
%%Creator: fig2dev
%%CreationDate: Wed Oct 30 20:47:37 1996
%%For: rhill@dante (Robert Hill)
%%BoundingBox: 0 0 522 477
%%Pages: 0
%%EndComments
/$F2psDict 200 dict def 
$F2psDict begin
$F2psDict /mtrx matrix put
/l {lineto} bind def
/m {moveto} bind def
/s {stroke} bind def
/n {newpath} bind def
/gs {gsave} bind def
/gr {grestore} bind def
/clp {closepath} bind def
/graycol {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
4 -2 roll mul setrgbcolor} bind def
/col-1 {} def
/col0 {0 0 0 setrgbcolor} bind def
/col1 {0 0 1 setrgbcolor} bind def
/col2 {0 1 0 setrgbcolor} bind def
/col3 {0 1 1 setrgbcolor} bind def
/col4 {1 0 0 setrgbcolor} bind def
/col5 {1 0 1 setrgbcolor} bind def
/col6 {1 1 0 setrgbcolor} bind def
/col7 {1 1 1 setrgbcolor} bind def
	end
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def
%%EndProlog

$F2psBegin
0 setlinecap 0 setlinejoin
-67.0 540.0 translate 0.900 -0.900 scale
0.500 setlinewidth
% Polyline
n 654 234 m 654 69 l  509 69 l  509 234 l 
 clp gs col-1 s gr
% Polyline
n 509 379 m 509 234 l  654 234 l  654 379 l 
 clp gs col-1 s gr
% Polyline
n 219 239 m 219 74 l  74 74 l  74 239 l 
 clp gs col-1 s gr
% Polyline
n 74 384 m 74 239 l  219 239 l  219 384 l 
 clp gs col-1 s gr
% Polyline
n 144 259 m 144 379 l  144 379 l gs col-1 s gr
% Polyline
n 209 279 m 209 259 l  84 259 l  84 279 l 
 clp gs col-1 s gr
% Polyline
n 209 299 m 209 279 l  84 279 l  84 299 l 
 clp gs col-1 s gr
% Polyline
n 209 319 m 209 299 l  84 299 l  84 319 l 
 clp gs col-1 s gr
% Polyline
n 209 339 m 209 319 l  84 319 l  84 339 l 
 clp gs col-1 s gr
% Polyline
n 209 359 m 209 339 l  84 339 l  84 359 l 
 clp gs col-1 s gr
% Polyline
n 209 379 m 209 359 l  84 359 l  84 379 l 
 clp gs col-1 s gr
% Polyline
n 579 254 m 579 374 l  579 374 l gs col-1 s gr
% Polyline
n 644 274 m 644 254 l  519 254 l  519 274 l 
 clp gs col-1 s gr
% Polyline
n 644 294 m 644 274 l  519 274 l  519 294 l 
 clp gs col-1 s gr
% Polyline
n 644 314 m 644 294 l  519 294 l  519 314 l 
 clp gs col-1 s gr
% Polyline
n 644 334 m 644 314 l  519 314 l  519 334 l 
 clp gs col-1 s gr
% Polyline
n 644 354 m 644 334 l  519 334 l  519 354 l 
 clp gs col-1 s gr
% Polyline
n 644 374 m 644 354 l  519 354 l  519 374 l 
 clp gs col-1 s gr
% Polyline
n 444 144 m 444 79 l  274 79 l  274 144 l 
 clp gs col-1 s gr
% Polyline
n 444 209 m 444 144 l  274 144 l  274 209 l 
 clp gs col-1 s gr
% Polyline
n 444 274 m 444 209 l  274 209 l  274 274 l 
 clp gs col-1 s gr
% Polyline
n 444 339 m 444 274 l  274 274 l  274 339 l 
 clp gs col-1 s gr
% Polyline
n 444 404 m 444 339 l  274 339 l  274 404 l 
 clp gs col-1 s gr
% Polyline
n 444 469 m 444 404 l  274 404 l  274 469 l 
 clp gs col-1 s gr
% Polyline
n 444 534 m 444 469 l  274 469 l  274 534 l 
 clp gs col-1 s gr
% Polyline
n 444 599 m 444 534 l  274 534 l  274 599 l 
 clp gs col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 189 269 m 264 269 l  264 494 l  284 494 l gs col-1 s gr
	[] 0 setdash
n 276.000 492.000 m 284.000 494.000 l 276.000 496.000 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 194 289 m 254 289 l  254 374 l  289 374 l gs col-1 s gr
	[] 0 setdash
n 281.000 372.000 m 289.000 374.000 l 281.000 376.000 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 194 304 m 289 304 l gs col-1 s gr
	[] 0 setdash
n 281.000 302.000 m 289.000 304.000 l 281.000 306.000 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 199 329 m 239 329 l  239 234 l  289 234 l gs col-1 s gr
	[] 0 setdash
n 281.000 232.000 m 289.000 234.000 l 281.000 236.000 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 524 264 m 454 264 l  454 424 l  424 424 l gs col-1 s gr
	[] 0 setdash
n 432.000 426.000 m 424.000 424.000 l 432.000 422.000 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 524 284 m 464 284 l  464 109 l  419 109 l gs col-1 s gr
	[] 0 setdash
n 427.000 111.000 m 419.000 109.000 l 427.000 107.000 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 524 304 m 469 304 l  469 569 l  429 569 l gs col-1 s gr
	[] 0 setdash
n 437.000 571.000 m 429.000 569.000 l 437.000 567.000 l gs 2 setlinejoin col-1 s gr
/Times-Roman findfont 12.00 scalefont setfont
519 112 m 
gs 1 -1 scale (Status: READY) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
524 249 m 
gs 1 -1 scale (Page Table) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
519 94 m 
gs 1 -1 scale (Thread2) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
519 130 m 
gs 1 -1 scale (Name: shell) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
519 148 m 
gs 1 -1 scale (ThreadID: 2) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
84 99 m 
gs 1 -1 scale (Thread1) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
84 117 m 
gs 1 -1 scale (Status: READY) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
84 135 m 
gs 1 -1 scale (Name: Matmult) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
84 153 m 
gs 1 -1 scale (ThreadID: 4) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
89 254 m 
gs 1 -1 scale (Page Table) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
89 274 m 
gs 1 -1 scale (VPN: 0) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
89 294 m 
gs 1 -1 scale (VPN: 1) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
89 314 m 
gs 1 -1 scale (VPN: 2) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
89 334 m 
gs 1 -1 scale (VPN: 3) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
89 354 m 
gs 1 -1 scale (VPN: 4) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
89 374 m 
gs 1 -1 scale (VPN: 5) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
584 289 m 
gs 1 -1 scale (PPN: 0) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
524 269 m 
gs 1 -1 scale (VPN: 0) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
524 289 m 
gs 1 -1 scale (VPN: 1) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
524 309 m 
gs 1 -1 scale (VPN: 2) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
524 329 m 
gs 1 -1 scale (VPN: 3) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
524 349 m 
gs 1 -1 scale (VPN: 4) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
524 369 m 
gs 1 -1 scale (VPN: 5) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
149 274 m 
gs 1 -1 scale (PPN: 6) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
149 294 m 
gs 1 -1 scale (PPN: 4) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
149 314 m 
gs 1 -1 scale (PPN: 3) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
149 334 m 
gs 1 -1 scale (PPN: 2) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
149 354 m 
gs 1 -1 scale (PPN: 18) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
149 374 m 
gs 1 -1 scale (PPN: 41) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
584 269 m 
gs 1 -1 scale (PPN: 5) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
584 309 m 
gs 1 -1 scale (PPN: 7) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
584 329 m 
gs 1 -1 scale (PPN: 8) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
584 349 m 
gs 1 -1 scale (PPN: 10) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
584 369 m 
gs 1 -1 scale (PPN: 16) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
284 99 m 
gs 1 -1 scale (Page 0) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
284 164 m 
gs 1 -1 scale (Page 1) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
284 229 m 
gs 1 -1 scale (Page 2) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
284 294 m 
gs 1 -1 scale (Page 3) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
284 359 m 
gs 1 -1 scale (Page 4) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
284 419 m 
gs 1 -1 scale (Page 5) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
284 489 m 
gs 1 -1 scale (Page 6) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
284 554 m 
gs 1 -1 scale (Page 7) col-1 show gr
$F2psEnd

%%EndDocument
 @endspecial 1106 2663 a Fe(Figure)25 b(7:)j(Non-contiguous)g(Memory)c
(Allocation)141 2940 y(The)d Fd(File)g Fe(\002eld)g(points)h(to)f(a)g
(physical)i(\(Unix\))f(\002le)e(which)i(contains)h(the)e(program)i(te)o
(xt.)28 b(This)21 b(may)g(be)g(the)g(sw)o(ap\002le,)0
3053 y(in)28 b(the)g(case)h(of)f(a)g(program)h(that)g(has)g(been)g
(paged,)h(or)e(the)g(e)o(x)o(ecutable)j(\002le)c(from)h(which)h(the)f
(program)h(came.)43 b Fd(offset)0 3166 y Fe(then,)24
b(refers)h(to)e(the)h(page')-5 b(s)25 b(of)n(fset)f(within)g(the)g
(\002le.)141 3279 y(When)29 b(a)f(program)i(mak)o(es)f(a)f(reference)j
(to)d(a)g(logical)j(memory)d(address,)k(the)d(machine)g(in)l(v)n(ok)o
(es)i(the)e Fc(T)-5 b(r)o(anslate\(\))0 3392 y Fe(function)39
b(to)e(get)g(the)g(corresponding)k(physical)d(address.)71
b Fc(T)-5 b(r)o(anslate\(\))38 b Fe(\002nds)f(the)g(page)h(table)g
(entry)f(for)g(the)g(page)0 3505 y(containing)27 b(the)e(logical)h
(memory)f(address,)h(and)f(checks)h(it')-5 b(s)25 b Fc(valid)h
Fe(member)-5 b(.)31 b(If)24 b(the)h(page)g(is)g(\223v)n(alid\224,)h
(then)f Fc(T)-5 b(r)o(anslate)0 3618 y Fe(simply)30 b(computes)h(the)f
(physical)h(address)h(corresponding)h(to)d(the)f(logical)i(address)h
(it)d(w)o(as)g(passed,)j(and)e(this)g(is)f(then)0 3731
y(used)34 b(to)f(complete)h(the)f(original)i(memory)e(reference.If)i
(the)f(page)f(is)g(found)h(to)f(not)g(be)g(\223v)n(alid\224)h
(\(because)h(it)e(is)g(not)0 3844 y(currently)h(in)d(main)h(memory\),)i
(then)e(a)f(page)i(f)o(ault)f(e)o(xception)i(is)e(generated.)55
b(The)31 b(e)o(xception)j(handler)f(handles)h(the)0 3957
y(page)25 b(f)o(ault)h(by)f(sw)o(apping)h(the)f(desired)i(page)e(back)g
(into)h(main)e(memory)-6 b(.)33 b(The)24 b(instruction)k(that)d
(originally)i(performed)0 4069 y(the)d(memory)g(reference)h(is)f(then)g
(restarted.)31 b(This)23 b(process)j(is)d(illustrated)j(in)e(Figure)g
(8.)0 4362 y Ff(10)119 b(Demand)31 b(P)o(aging)0 4569
y Fe(When)g(a)g(Nachos)g(program)h(is)f(loaded,)j(only)e(its)f(\002rst)
f(and)h(last)h(pages)g(are)f(brought)i(into)e(main)g(memory)-6
b(.)51 b(The)31 b(\002rst)0 4682 y(page)e(will)f(be)g(the)g(\002rst)g
(page)h(of)f(the)g(program')-5 b(s)30 b(te)o(xt)e(se)o(gment,)i(and)f
(the)f(last)g(page)h(will)f(be)g(its)g(stack.)44 b(Ev)o(en)27
b(though)0 4795 y(only)i(tw)o(o)e(pages)i(of)f(the)g(program)i(are)e
(loaded)h(into)g(memory)-6 b(,)29 b(page)f(table)h(entries)h(are)e(set)
g(up)g(for)g(all)g(the)g(program')-5 b(s)0 4908 y(pages.)37
b(Ho)n(we)n(v)o(er)l(,)25 b(only)i(tw)o(o)e(of)h(these)h(entries)g
(\(the)f(\002rst)g(and)g(the)g(last\))g(will)g(contain)h(v)n(alid)g
(logical)g(to)f(physical)h(page)0 5021 y(mappings.)j(The)24
b(others)g(will)g(all)f(ha)n(v)o(e)h(their)h(\223v)n(alid\224)g(bits)f
(set)g(to)f(f)o(alse.)141 5134 y(Thus,)k(when)g(the)f(program)i(mak)o
(es)f(a)f(reference)j(to)d(a)h(page)g(that)g(has)g(not)g(been)g
(loaded,)h(it)f(will)f(\002nd)g(the)h(v)n(alid)g(bit)0
5246 y(of)k(its)f(page)i(table)f(entry)h(set)f(to)f(f)o(alse.)51
b(A)29 b(page)j(f)o(ault)f(e)o(xception)i(will)d(be)h(generated)i(as)e
(described)i(in)d(the)h(pre)n(vious)0 5359 y(section.)1905
5649 y(15)p eop end
%%Page: 16 16
TeXDict begin 16 15 bop 600 2696 a @beginspecial 0 @llx
0 @lly 680 @urx 679 @ury 3240 @rwi @setspecial
%%BeginDocument: figures/nachos8.eps
%!PS-Adobe-2.0 EPSF
%%Title: /tmp/xfig-fig000712
%%Creator: fig2dev
%%CreationDate: Wed Oct 30 20:47:48 1996
%%For: rhill@dante (Robert Hill)
%%BoundingBox: 0 0 680 679
%%Pages: 0
%%EndComments
/$F2psDict 200 dict def 
$F2psDict begin
$F2psDict /mtrx matrix put
/l {lineto} bind def
/m {moveto} bind def
/s {stroke} bind def
/n {newpath} bind def
/gs {gsave} bind def
/gr {grestore} bind def
/clp {closepath} bind def
/graycol {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
4 -2 roll mul setrgbcolor} bind def
/col-1 {} def
/col0 {0 0 0 setrgbcolor} bind def
/col1 {0 0 1 setrgbcolor} bind def
/col2 {0 1 0 setrgbcolor} bind def
/col3 {0 1 1 setrgbcolor} bind def
/col4 {1 0 0 setrgbcolor} bind def
/col5 {1 0 1 setrgbcolor} bind def
/col6 {1 1 0 setrgbcolor} bind def
/col7 {1 1 1 setrgbcolor} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y translate xrad yrad scale 0 0 1 startangle endangle arc
	savematrix setmatrix
	} def

	end
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def
%%EndProlog

$F2psBegin
0 setlinecap 0 setlinejoin
-4.0 756.0 translate 0.900 -0.900 scale
/Times-Roman findfont 10.00 scalefont setfont
39 184 m 
gs 1 -1 scale (if \(exception != NoException\) {) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
54 199 m 
gs 1 -1 scale (machine->RaiseException\(exception, addr\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
54 214 m 
gs 1 -1 scale (return FALSE;) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 229 m 
gs 1 -1 scale (}) col-1 show gr
0.500 setlinewidth
% Polyline
n 359 559 m 359 99 l  19 99 l  19 559 l 
 clp gs col-1 s gr
/Times-Roman findfont 10.00 scalefont setfont
29 139 m 
gs 1 -1 scale ({) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
29 124 m 
gs 1 -1 scale (Machine::ReadMem\(int addr, int size, int *value\)) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
29 549 m 
gs 1 -1 scale (}) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 154 m 
gs 1 -1 scale (exception = Translate\(addr, &physicalAddress, size, FALSE\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 529 m 
gs 1 -1 scale (return \(TRUE\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 274 m 
gs 1 -1 scale (switch\(size\) {) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 289 m 
gs 1 -1 scale (  case 1:) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 319 m 
gs 1 -1 scale (    *\(char *\)value = \(char\) data;) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 334 m 
gs 1 -1 scale (    break) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 349 m 
gs 1 -1 scale ( ) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 394 m 
gs 1 -1 scale (    *\(unsigned short *\)value = ShortToHost\(data\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 409 m 
gs 1 -1 scale (    break;) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 424 m 
gs 1 -1 scale (  case 4:) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 439 m 
gs 1 -1 scale (    data = *\(unsigned int *\) &machine->mainMemory[physicalAddress];) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 454 m 
gs 1 -1 scale (    *value = WordToHost\(data\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 469 m 
gs 1 -1 scale (    breakl) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 484 m 
gs 1 -1 scale (  default: ASSERT\(FALSE\)) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 499 m 
gs 1 -1 scale (}) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 379 m 
gs 1 -1 scale (    data = *\(unsigned short *\) &machine->mainMemory[physicalAddress];) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 364 m 
gs 1 -1 scale (  case 2:) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
39 304 m 
gs 1 -1 scale (    data = machine->mainMemory[physicalAddress];) col-1 show gr
% Polyline
n 729 509 m 729 429 l  449 429 l  449 509 l 
 clp gs col-1 s gr
% Polyline
n 729 509 m 729 509 l  729 509 l  729 509 l 
 clp gs col-1 s gr
/Times-Roman findfont 10.00 scalefont setfont
459 444 m 
gs 1 -1 scale (Machine::RaiseException\(ExceptionType which, int badVAddr\)) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 459 m 
gs 1 -1 scale ({) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 474 m 
gs 1 -1 scale (    registers[BadVAddrReg] = badVAddr;) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 489 m 
gs 1 -1 scale (    ExceptionHandler\(which\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 504 m 
gs 1 -1 scale (}) col-1 show gr
% Polyline
n 449 389 m 449 109 l  759 109 l  759 389 l 
 734 374 l  719 399 l  704 374 l  689 404 l  669 359 l 
 659 389 l  644 364 l gs col-1 s gr
n 644 364 m 634 389 l  589 364 l  574 384 l 
 554 364 l  524 384 l  489 369 l  449 389 l gs col-1 s gr
/Times-Roman findfont 10.00 scalefont setfont
459 139 m 
gs 1 -1 scale (ExceptionType) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 154 m 
gs 1 -1 scale (Machine::Translate\(int virtAddr, int *physAddr, int size, bool writing\)) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 169 m 
gs 1 -1 scale ({) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
479 189 m 
gs 1 -1 scale (// Calculate the virtual page number, and offset within the page.) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
479 204 m 
gs 1 -1 scale (// from the virtual address.) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
479 219 m 
gs 1 -1 scale (vpn = \(unsigned\) virtAddr / PageSize;) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
479 234 m 
gs 1 -1 scale (offset = \(unsigned\) virtAddr % PageSize;) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
479 264 m 
gs 1 -1 scale (if \(vpn >= pageTableSize\) {) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
479 279 m 
gs 1 -1 scale (    return AddressErrorException;) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
479 299 m 
gs 1 -1 scale (} else if \(!pageTable[vpn].valid\) {) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
479 314 m 
gs 1 -1 scale (    WriteRegister\(BadVAddrReg, vpn\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
479 329 m 
gs 1 -1 scale (    return PageFaultException;) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
479 344 m 
gs 1 -1 scale (}) col-1 show gr
% Polyline
n 449 719 m 449 539 l  739 539 l  739 719 l 
 719 704 l  709 724 l  694 699 l  659 729 l  644 704 l 
 639 724 l  614 699 l gs col-1 s gr
n 614 699 m 579 724 l  564 699 l  534 724 l 
 519 714 l  489 719 l  469 709 l  449 719 l gs col-1 s gr
/Times-Roman findfont 10.00 scalefont setfont
459 554 m 
gs 1 -1 scale (void ExceptionHandler\(ExceptionType which\)) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 569 m 
gs 1 -1 scale ({) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 584 m 
gs 1 -1 scale (  int type = machine->ReadRegister\(2\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 599 m 
gs 1 -1 scale (  ) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 614 m 
gs 1 -1 scale (  if \(which == SyscallException\) {) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 629 m 
gs 1 -1 scale (     do_system_call\(type\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 644 m 
gs 1 -1 scale (  } else if \(which == PageFaultException\) {) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 659 m 
gs 1 -1 scale (     int virtaddr = machine->ReadRegister\(BadVAddrReg\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 674 m 
gs 1 -1 scale (     stats->numPageFaults++;) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 689 m 
gs 1 -1 scale (     memory->pagein\( virtaddr / PageSize, currentThread->space\);) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
459 704 m 
gs 1 -1 scale (} else if {) col-1 show gr
n 445.755 548.890 m 454.000 549.000 l 446.673 552.783 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
n 446.146 515.704 34.211 -67.931 76.727 arcn
gs col-1 s gr
	[] 0 setdash
% Ellipse
n 119 779 60 60 0 360 DrawEllipse gs col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 294 149 m 454 149 l gs col-1 s gr
	[] 0 setdash
n 446.000 147.000 m 454.000 149.000 l 446.000 151.000 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 239 194 m 454 439 l gs col-1 s gr
	[] 0 setdash
n 450.227 431.668 m 454.000 439.000 l 447.220 434.306 l gs 2 setlinejoin col-1 s gr
% Polyline
n 279 819 m 419 819 l  419 739 l  279 739 l 
 clp gs col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 279 779 m 179 779 l gs col-1 s gr
	[] 0 setdash
n 187.000 781.000 m 179.000 779.000 l 187.000 777.000 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 59 779 m 4 779 l  4 209 l gs col-1 s gr
	[] 0 setdash
	[4.000000] 0 setdash
% Polyline
n 4 214 m 4 119 l  24 119 l gs col-1 s gr
	[] 0 setdash
n 16.000 117.000 m 24.000 119.000 l 16.000 121.000 l gs 2 setlinejoin col-1 s gr
	[4.000000] 0 setdash
% Polyline
n 599 709 m 599 779 l  419 779 l gs col-1 s gr
	[] 0 setdash
n 427.000 781.000 m 419.000 779.000 l 427.000 777.000 l gs 2 setlinejoin col-1 s gr
/Times-Roman findfont 12.00 scalefont setfont
69 799 m 
gs 1 -1 scale (Original Instruction) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
74 764 m 
gs 1 -1 scale (Machine Restarts) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
289 774 m 
gs 1 -1 scale (Memory Manager Swaps) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
289 799 m 
gs 1 -1 scale (Page into Main Memory) col-1 show gr
/Times-Roman findfont 10.00 scalefont setfont
29 114 m 
gs 1 -1 scale (bool ) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
449 104 m 
gs 1 -1 scale (machine/translate.cc) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
19 94 m 
gs 1 -1 scale (machine/translate.cc) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
449 419 m 
gs 1 -1 scale (machine/machine.cc) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
449 534 m 
gs 1 -1 scale (userprog/exception.cc) col-1 show gr
/Times-Roman findfont 12.00 scalefont setfont
279 734 m 
gs 1 -1 scale (userprog/memmgr.cc) col-1 show gr
$F2psEnd

%%EndDocument
 @endspecial 1535 2892 a Fe(Figure)24 b(8:)29 b(A)22
b(P)o(age)h(F)o(ault)141 3169 y(Nachos)f(handles)g(page)g(f)o(aults)g
(by)f(loading)h(the)f(referenced)j(page)d(into)h(main)f(memory)-6
b(,)21 b(and)g(restarting)i(the)e(instruc-)0 3282 y(tion)27
b(that)g(generated)h(the)f(page)g(f)o(ault.)38 b(P)o(ages)26
b(are)g(sw)o(apped)i(in)e(using)h(the)g Fc(MemoryMana)o(g)o(er::pa)o(g)
o(ein\()q(\))k Fe(function.)39 b(In)0 3395 y(order)27
b(to)e(sw)o(ap)h(a)g(page)g(in,)g(this)g(function)i(may)e(need)g(to)g
(sw)o(ap)g(another)h(page)g(out)f(\(if)g(there)h(are)e(no)h(free)h
(pages\).)36 b(This)0 3508 y(is)23 b(done)i(using)g(the)e
Fc(MemoryMana)o(g)o(er::pa)o(g)o(eo)q(ut\()q(\))29 b
Fe(function.)141 3621 y(The)23 b(\002le)g(from)g(which)g(a)g(page)h(is)
f(read)h(when)g(being)g(sw)o(apped)h(into)f(memory)f(will)g(v)n(ary)h
(depending)i(on)d(the)h(nature)0 3734 y(of)19 b(the)f(page.)28
b(The)19 b Fc(T)-5 b(r)o(anslationEntry)21 b Fe(object)f(of)f(each)g
(page)h(contains)g(a)f(pointer)h(to)e(an)h Fc(OpenF)l(ile)g
Fe(object.)29 b(This)18 b(member)0 3846 y(points)25 b(to)f(the)f
(\002le)g(from)h(which)g(the)g(page)g(can)g(be)g(read)g(if)f(it)g(gets)
i(sw)o(apped)g(out)f(to)f(disk)h(and)g(has)g(to)g(be)f(sw)o(apped)i
(back)0 3959 y(into)30 b(main)f(memory)-6 b(.)46 b(This)28
b(will)h(point)h(to)f(the)h(sw)o(ap)f(\002le,)h(if)e(the)i(page)g(had)f
(been)h(modi\002ed)g(before)g(it)f(w)o(as)g(sw)o(apped)0
4072 y(out,)c(or)g(the)g(original)i(e)o(x)o(ecutable)g(\002le)d(if)h
(it)f(has)i(not)f(been)h(modi\002ed.)33 b(If)24 b(the)h(page)h
(contained)i(only)d(uninitialized)k(data,)0 4185 y(the)d(pointer)h(to)e
(the)h Fc(OpenF)l(ile)g Fe(object)h(is)e(set)h(to)f(NULL)f(\(since)i
(the)g(page)g(w)o(ould)g(contain)i(only)e(zeros,)h(and)f(w)o(ould)g
(not)0 4298 y(need)e(to)g(be)f(read)i(from)e(a)g(disk)h(\002le)f(when)h
(sw)o(apped)h(back)f(into)g(main)g(memory\).)0 4591 y
Ff(11)119 b(Concluding)32 b(Remarks)0 4798 y Fe(As)19
b(of)g(this)h(writing,)h(Nachos)f(incorporates)j(most)c(of)g(the)h
(standard)i(operating)f(system)g(features)g(such)f(as)f(multi-tasking,)
0 4911 y(preempti)n(v)o(e)26 b(scheduling)i(and)e(virtual)g(memory)-6
b(.)33 b(While)25 b(these)h(systems)g(are)f(functional)j(and)d
(reasonably)j(stable,)e(the)o(y)0 5024 y(are)31 b(certainly)h(not)f
(optimal.)50 b(During)32 b(most)e(of)g(our)h(coding,)j(we)29
b(ha)n(v)o(e)i(tried)h(to)e(gi)n(v)o(e)g(clarity)i(a)e(higher)i
(priority)g(than)0 5136 y(optimal)25 b(performance.)31
b(W)-7 b(e)22 b(hope)j(this)f(will)f(aid)h(you)g(in)g(your)g(Nachos)g
(programming)i(endea)n(v)n(ors.)1905 5649 y(16)p eop
end
%%Trailer

userdict /end-hook known{end-hook}if
%%EOF
